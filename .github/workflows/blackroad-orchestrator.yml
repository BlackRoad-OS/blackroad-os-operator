name: BlackRoad Orchestrator

# This is the MASTER workflow that orchestrates ALL BlackRoad deployments
# Any PR merge to main triggers full E2E deployment across:
# - 25+ Cloudflare Workers
# - 11 Cloudflare Pages projects
# - Railway services
# - All 16 domains

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_scope:
        description: 'What to deploy'
        required: true
        type: choice
        options:
          - full
          - workers-only
          - pages-only
          - railway-only
          - specific-domain
        default: 'full'
      target_domain:
        description: 'Target domain (if specific-domain selected)'
        required: false
        type: string
      force_all:
        description: 'Force deploy everything (ignore change detection)'
        type: boolean
        default: false

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: 848cf0b18d51e0170e0d1537aec3505a
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # CHANGE DETECTION & ROUTING
  # ============================================================================
  analyze:
    name: Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      deploy_workers: ${{ steps.routing.outputs.deploy_workers }}
      deploy_pages: ${{ steps.routing.outputs.deploy_pages }}
      deploy_railway: ${{ steps.routing.outputs.deploy_railway }}
      worker_matrix: ${{ steps.workers.outputs.matrix }}
      pages_matrix: ${{ steps.pages.outputs.matrix }}
      domains_affected: ${{ steps.domains.outputs.affected }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - name: Determine Routing
        id: routing
        run: |
          SCOPE="${{ github.event.inputs.deploy_scope || 'full' }}"
          FORCE="${{ github.event.inputs.force_all }}"

          if [ "$SCOPE" == "full" ] || [ "$FORCE" == "true" ]; then
            echo "deploy_workers=true" >> $GITHUB_OUTPUT
            echo "deploy_pages=true" >> $GITHUB_OUTPUT
            echo "deploy_railway=true" >> $GITHUB_OUTPUT
          elif [ "$SCOPE" == "workers-only" ]; then
            echo "deploy_workers=true" >> $GITHUB_OUTPUT
            echo "deploy_pages=false" >> $GITHUB_OUTPUT
            echo "deploy_railway=false" >> $GITHUB_OUTPUT
          elif [ "$SCOPE" == "pages-only" ]; then
            echo "deploy_workers=false" >> $GITHUB_OUTPUT
            echo "deploy_pages=true" >> $GITHUB_OUTPUT
            echo "deploy_railway=false" >> $GITHUB_OUTPUT
          elif [ "$SCOPE" == "railway-only" ]; then
            echo "deploy_workers=false" >> $GITHUB_OUTPUT
            echo "deploy_pages=false" >> $GITHUB_OUTPUT
            echo "deploy_railway=true" >> $GITHUB_OUTPUT
          else
            # Auto-detect from changed files
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
            echo "deploy_workers=$(echo "$CHANGED" | grep -q '^workers/' && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "deploy_pages=$(echo "$CHANGED" | grep -q '^pages/' && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "deploy_railway=$(echo "$CHANGED" | grep -qE '^(src/|br_operator/|Dockerfile|railway)' && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

      - name: Build Worker Matrix
        id: workers
        run: |
          # Only include workers that have wrangler.toml (deployable)
          WORKERS=$(for d in workers/*/; do
            if [ -f "${d}wrangler.toml" ]; then
              basename "$d"
            fi
          done | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix=$WORKERS" >> $GITHUB_OUTPUT
          echo "Deployable workers: $WORKERS"

      - name: Build Pages Matrix
        id: pages
        run: |
          # Only include pages directories that have index.html or package.json
          PAGES=$(for d in pages/*/; do
            if [ -f "${d}index.html" ] || [ -f "${d}package.json" ]; then
              basename "$d"
            fi
          done | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix=$PAGES" >> $GITHUB_OUTPUT
          echo "Deployable pages: $PAGES"

      - name: Identify Affected Domains
        id: domains
        run: |
          cat << 'EOF' > /tmp/domain-map.json
          {
            "blackroad.io": ["router", "api-gateway", "blackroad-os-web"],
            "blackroadai.com": ["blackroadai-router", "blackroad-os-web"],
            "blackroad.network": ["blackroad-network-router", "blackroad-os-web"],
            "blackroadquantum.com": ["blackroadquantum-router", "blackroad-os-web"],
            "lucidia.earth": ["lucidia-earth-router", "blackroad-os-web"],
            "lucidia.studio": ["lucidia-studio-router", "blackroad-os-web"],
            "blackroad.systems": ["systems-router", "blackroad-os-web"],
            "blackroad.me": ["blackroad-os-web"],
            "blackroadinc.us": ["blackroad-os-web"],
            "aliceqi.com": ["blackroad-os-web"],
            "lucidiaqi.com": ["blackroad-os-web"],
            "blackroadqi.com": ["blackroad-os-web"],
            "api.blackroad.io": ["api-gateway"],
            "cece.blackroad.io": ["cece"],
            "auth.blackroad.io": ["auth"],
            "billing.blackroad.io": ["stripe-billing"],
            "checkout.blackroad.io": ["stripe-checkout"],
            "webhooks.blackroad.io": ["stripe-webhooks"],
            "status.blackroad.io": ["status"],
            "identity.blackroad.io": ["identity"],
            "cipher.blackroad.io": ["cipher"],
            "sovereignty.blackroad.io": ["sovereignty"]
          }
          EOF

          # Get all affected domains
          ALL_DOMAINS=$(jq -r 'keys[]' /tmp/domain-map.json | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "affected=$ALL_DOMAINS" >> $GITHUB_OUTPUT

  # ============================================================================
  # DEPLOY ALL CLOUDFLARE WORKERS
  # ============================================================================
  deploy-workers:
    name: Deploy Workers
    needs: analyze
    if: needs.analyze.outputs.deploy_workers == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker: ${{ fromJson(needs.analyze.outputs.worker_matrix) }}
      fail-fast: false
      max-parallel: 5
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Deploy ${{ matrix.worker }}
        working-directory: workers/${{ matrix.worker }}
        run: |
          npm install -g wrangler
          if [ -f "package.json" ]; then
            npm ci --prefer-offline --no-audit 2>/dev/null || npm install
          fi

          # Deploy with retry
          for i in 1 2 3; do
            if wrangler deploy 2>&1; then
              echo "âœ… ${{ matrix.worker }} deployed successfully"
              exit 0
            fi
            echo "Retry $i..."
            sleep 5
          done
          echo "âŒ Failed to deploy ${{ matrix.worker }}"
          exit 1

  # ============================================================================
  # DEPLOY CLOUDFLARE PAGES
  # ============================================================================
  deploy-pages:
    name: Deploy Pages
    needs: analyze
    if: needs.analyze.outputs.deploy_pages == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        page: ${{ fromJson(needs.analyze.outputs.pages_matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build & Deploy ${{ matrix.page }}
        working-directory: pages/${{ matrix.page }}
        run: |
          npm install -g wrangler

          # Install and build if package.json exists
          if [ -f "package.json" ]; then
            npm ci --prefer-offline --no-audit 2>/dev/null || npm install
            npm run build 2>/dev/null || true
          fi

          # Detect output directory
          if [ -d "dist" ]; then OUTPUT="dist"
          elif [ -d "build" ]; then OUTPUT="build"
          elif [ -d "out" ]; then OUTPUT="out"
          elif [ -d ".next" ]; then OUTPUT=".next"
          else OUTPUT="."
          fi

          PROJECT="blackroad-${{ matrix.page }}"
          wrangler pages project create "$PROJECT" --production-branch main 2>/dev/null || true
          wrangler pages deploy "$OUTPUT" --project-name="$PROJECT" --branch=main

  # ============================================================================
  # DEPLOY RAILWAY BACKEND
  # ============================================================================
  deploy-railway:
    name: Deploy Railway
    needs: analyze
    if: needs.analyze.outputs.deploy_railway == 'true' && vars.RAILWAY_PROJECT_ID != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        run: |
          # Use project token if available, otherwise skip
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âš ï¸ No Railway token configured, skipping Railway deployment"
            echo "To enable: Add RAILWAY_TOKEN secret with project-specific token"
            exit 0
          fi

          # Link to project if PROJECT_ID is set
          if [ -n "${{ vars.RAILWAY_PROJECT_ID }}" ]; then
            railway link "${{ vars.RAILWAY_PROJECT_ID }}" --environment production 2>/dev/null || true
          fi

          railway up --detach || echo "Railway deployment skipped (no project linked)"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

  # ============================================================================
  # TRIGGER CROSS-REPO DEPLOYMENTS
  # ============================================================================
  trigger-related-repos:
    name: Trigger Related Repos
    needs: [deploy-workers, deploy-pages]
    if: always() && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger blackroad-os-web
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3
        with:
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          repository: BlackRoad-OS/blackroad-os-web
          event-type: upstream-deploy
          client-payload: '{"ref": "${{ github.sha }}", "source": "blackroad-os-operator"}'
        continue-on-error: true

      - name: Trigger blackroad-os-api
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3
        with:
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          repository: BlackRoad-OS/blackroad-os-api
          event-type: upstream-deploy
          client-payload: '{"ref": "${{ github.sha }}", "source": "blackroad-os-operator"}'
        continue-on-error: true

  # ============================================================================
  # HEALTH CHECK ALL DOMAINS
  # ============================================================================
  health-check:
    name: Verify All Domains
    needs: [deploy-workers, deploy-pages, deploy-railway]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check All Domains
        run: |
          DOMAINS=(
            "blackroad.io"
            "blackroadai.com"
            "blackroad.network"
            "blackroadquantum.com"
            "lucidia.earth"
            "lucidia.studio"
            "blackroad.systems"
            "blackroad.me"
            "blackroadinc.us"
            "aliceqi.com"
            "lucidiaqi.com"
            "blackroadqi.com"
            "api.blackroad.io"
            "cece.blackroad.io"
          )

          echo "## Domain Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Domain | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

          FAILED=0
          for domain in "${DOMAINS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://$domain" || echo "timeout")
            if [ "$STATUS" == "200" ] || [ "$STATUS" == "301" ] || [ "$STATUS" == "302" ]; then
              echo "| $domain | âœ… $STATUS |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $domain | âŒ $STATUS |" >> $GITHUB_STEP_SUMMARY
              FAILED=$((FAILED + 1))
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $FAILED -gt 0 ]; then
            echo "âš ï¸ $FAILED domains failed health check" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All domains healthy!" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # DEPLOYMENT SUMMARY
  # ============================================================================
  summary:
    name: Deployment Summary
    needs: [analyze, deploy-workers, deploy-pages, deploy-railway, health-check]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ BlackRoad Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workers | ${{ needs.deploy-workers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pages | ${{ needs.deploy-pages.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Railway | ${{ needs.deploy-railway.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
