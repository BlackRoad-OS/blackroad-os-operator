name: Health Monitor

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Check Service Health
    runs-on: ubuntu-latest

    steps:
      - name: Check Operator Health
        id: operator
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://blackroad-operator.up.railway.app/health)
          echo "status=$RESPONSE" >> $GITHUB_OUTPUT
          if [ "$RESPONSE" != "200" ]; then
            echo "âŒ Operator health check failed (HTTP $RESPONSE)" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… Operator healthy" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Agent Catalog
        run: |
          RESPONSE=$(curl -s https://blackroad-operator.up.railway.app/agents)
          AGENT_COUNT=$(echo $RESPONSE | jq '. | length')

          echo "## Agent Catalog Status" >> $GITHUB_STEP_SUMMARY
          echo "- Agents loaded: $AGENT_COUNT" >> $GITHUB_STEP_SUMMARY

          if [ "$AGENT_COUNT" -lt 50 ]; then
            echo "âš ï¸ Low agent count (expected 58+)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          gh issue create \
            --title "ðŸš¨ Health Check Failed - $(date +%Y-%m-%d)" \
            --body "Automated health check detected service degradation." \
            --label "bug,health-check"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
