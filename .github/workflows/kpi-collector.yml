name: Daily KPI Collection & Dashboard Update

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  push:
    paths:
      - 'scripts/collect-kpi-data.py'
      - 'scripts/verify-kpis.sh'
      - '.github/workflows/kpi-collector.yml'
  workflow_dispatch:  # Manual trigger

jobs:
  collect-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git stats

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install yq (for YAML parsing)
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "$GH_TOKEN" | gh auth login --with-token

      - name: Collect KPI data
        run: python3 scripts/collect-kpi-data.py

      - name: Copy metrics to dashboard
        run: |
          mkdir -p pages/kpi-dashboard/metrics/data
          cp metrics/data/latest.json pages/kpi-dashboard/metrics/data/latest.json

      - name: Generate audit report
        run: bash scripts/verify-kpis.sh

      - name: Commit and push changes
        run: |
          git config user.name "KPI Bot"
          git config user.email "kpi-bot@blackroad.io"

          COMMIT_DATE=$(date +"%Y-%m-%d %H:%M UTC")

          git add metrics/data/
          git add pages/kpi-dashboard/metrics/data/

          # Create commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“Š Daily KPI Update - $COMMIT_DATE

Automated metrics collection:
- Code metrics: LOC, files, commits
- Infrastructure: Cloudflare, CI/CD, containers
- Agents & APIs: Catalog analysis
- GitHub: Organizations & repositories

Verification: PS-SHA-âˆž hash included
Generated by: .github/workflows/kpi-collector.yml
"
            git push
          else
            echo "No changes to commit"
          fi

      - name: Create deployment summary
        run: |
          echo "# KPI Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Collection Complete**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f metrics/data/latest.json ]; then
            echo "## Metrics" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat metrics/data/latest.json | jq '.metadata + {code: .code | {total_loc, total_files, total_commits}, infrastructure: .infrastructure.cloudflare, agents: .agents.total, github: .github.total_repos}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Dashboard:** [View Live](https://kpi.blackroad.io)" >> $GITHUB_STEP_SUMMARY
