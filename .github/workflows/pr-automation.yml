name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  pull_request_review:
    types: [submitted]

jobs:
  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Label based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Label based on size
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          FILES_CHANGED=$(gh pr view $PR_NUMBER --json files --jq '.files | length')

          if [ $FILES_CHANGED -lt 5 ]; then
            gh pr edit $PR_NUMBER --add-label "size/small"
          elif [ $FILES_CHANGED -lt 20 ]; then
            gh pr edit $PR_NUMBER --add-label "size/medium"
          else
            gh pr edit $PR_NUMBER --add-label "size/large"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run code review checks
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Check for common issues
          ISSUES=""

          # Check if tests were added
          if git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -q "^tests/"; then
            echo "âœ… Tests added" >> review.md
          else
            echo "âš ï¸ No tests added - consider adding tests" >> review.md
            ISSUES="$ISSUES\n- No tests added"
          fi

          # Check for TODO comments
          if git diff origin/${{ github.base_ref }}...HEAD | grep -q "TODO"; then
            echo "âš ï¸ TODO comments found - resolve before merging" >> review.md
            ISSUES="$ISSUES\n- TODO comments present"
          fi

          # Check for console.log or print statements
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E "(console\.log|print\()" | grep -v "logger" | grep -q .; then
            echo "âš ï¸ Debug statements found (console.log/print)" >> review.md
            ISSUES="$ISSUES\n- Debug statements present"
          fi

          # Post review comment
          if [ ! -z "$ISSUES" ]; then
            gh pr comment $PR_NUMBER --body "$(cat review.md)"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Approve and merge
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sweep-bot:
    name: Sweep Bot - Create Merge-Ready PRs
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'sweep')
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio ruff black isort

      - name: Run auto-fixes
        run: |
          # Auto-format code
          black br_operator/ tests/
          isort br_operator/ tests/

          # Fix auto-fixable lint issues
          ruff check --fix br_operator/ tests/ || true

      - name: Run tests
        run: |
          pytest tests/ -v

      - name: Commit changes
        run: |
          git config --global user.name "sweep-bot"
          git config --global user.email "sweep@blackroad.systems"

          git add -A
          git diff --staged --quiet || git commit -m "ðŸ§¹ sweep-bot: Auto-format and fix lint issues"
          git push

      - name: Update PR description
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --add-label "merge-ready" --body "âœ… Sweep complete - code formatted, linted, and tested"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
