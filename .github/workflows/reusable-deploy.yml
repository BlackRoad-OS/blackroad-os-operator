# Reusable BlackRoad Deployment Workflow
# Other repos can call this to trigger deployments

name: Reusable Deploy

on:
  workflow_call:
    inputs:
      deploy_type:
        description: 'Type of deployment'
        required: true
        type: string
      target:
        description: 'Target to deploy (worker name, pages project, or domain)'
        required: true
        type: string
      source_repo:
        description: 'Source repository triggering this deploy'
        required: false
        type: string
        default: ''
    secrets:
      CLOUDFLARE_API_TOKEN:
        required: true
      RAILWAY_TOKEN:
        required: false
      CROSS_REPO_TOKEN:
        required: false

  repository_dispatch:
    types: [deploy-worker, deploy-pages, deploy-domain, upstream-deploy]

env:
  CLOUDFLARE_ACCOUNT_ID: 848cf0b18d51e0170e0d1537aec3505a

jobs:
  deploy-worker:
    if: inputs.deploy_type == 'worker' || github.event.action == 'deploy-worker'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Deploy Worker
        run: |
          TARGET="${{ inputs.target || github.event.client_payload.target }}"
          cd "workers/$TARGET"

          npm install -g wrangler
          [ -f package.json ] && npm ci

          wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  deploy-pages:
    if: inputs.deploy_type == 'pages' || github.event.action == 'deploy-pages'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Deploy Pages
        run: |
          TARGET="${{ inputs.target || github.event.client_payload.target }}"

          npm install -g wrangler

          # Check if it's a local pages directory or external
          if [ -d "pages/$TARGET" ]; then
            cd "pages/$TARGET"
            [ -f package.json ] && npm ci && npm run build 2>/dev/null || true

            # Detect output
            if [ -d "dist" ]; then OUTPUT="dist"
            elif [ -d "build" ]; then OUTPUT="build"
            else OUTPUT="."
            fi

            wrangler pages deploy "$OUTPUT" --project-name="$TARGET" --branch=main
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  deploy-domain:
    if: inputs.deploy_type == 'domain' || github.event.action == 'deploy-domain'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse Domain Config
        id: config
        run: |
          TARGET="${{ inputs.target || github.event.client_payload.target }}"

          # Read domains.yaml and find config for this domain
          WORKERS=$(yq -r ".domains[\"$TARGET\"].workers // [] | .[]" config/domains.yaml 2>/dev/null || echo "")
          PAGES=$(yq -r ".domains[\"$TARGET\"].pages_project // \"\"" config/domains.yaml 2>/dev/null || echo "")

          echo "workers=$WORKERS" >> $GITHUB_OUTPUT
          echo "pages=$PAGES" >> $GITHUB_OUTPUT
          echo "Domain $TARGET: workers=[$WORKERS], pages=$PAGES"

      - name: Deploy Associated Workers
        if: steps.config.outputs.workers != ''
        run: |
          npm install -g wrangler
          for worker in ${{ steps.config.outputs.workers }}; do
            echo "Deploying worker: $worker"
            cd "workers/$worker"
            [ -f package.json ] && npm ci
            wrangler deploy
            cd ../..
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  # Handle upstream repository deployments
  upstream-deploy:
    if: github.event.action == 'upstream-deploy'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Handle Upstream Deploy
        run: |
          SOURCE="${{ github.event.client_payload.source }}"
          REF="${{ github.event.client_payload.ref }}"

          echo "Triggered by upstream: $SOURCE at $REF"

          # Based on source, determine what to deploy
          case "$SOURCE" in
            "blackroad-os-web")
              echo "Web updated - redeploying routers"
              # Trigger router workers to pick up new content
              ;;
            "blackroad-os-api")
              echo "API updated - checking dependencies"
              ;;
            *)
              echo "Unknown source: $SOURCE"
              ;;
          esac
