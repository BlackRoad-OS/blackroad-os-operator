name: Sync Infrastructure Across Orgs

on:
  push:
    branches: [main]
    paths:
      - 'config/endpoints-wiring.yaml'
      - 'config/infrastructure.yaml'
  workflow_dispatch:
  schedule:
    # Sync weekly
    - cron: '0 0 * * 0'

jobs:
  sync-github-orgs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        org:
          - BlackRoad-OS
          - BlackRoad-AI
          - BlackRoad-Cloud
          - BlackRoad-Labs
          - BlackRoad-Security
    steps:
      - uses: actions/checkout@v4

      - name: Sync org secrets
        env:
          GH_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}
        run: |
          # Sync common secrets to all orgs
          gh secret set CLOUDFLARE_ACCOUNT_ID \
            --org ${{ matrix.org }} \
            --body "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
            2>/dev/null || echo "Secret may already exist"

          gh secret set CLOUDFLARE_API_TOKEN \
            --org ${{ matrix.org }} \
            --body "${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            2>/dev/null || echo "Secret may already exist"

          gh secret set RAILWAY_TOKEN \
            --org ${{ matrix.org }} \
            --body "${{ secrets.RAILWAY_TOKEN }}" \
            2>/dev/null || echo "Secret may already exist"

  sync-cloudflare-kv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Sync KV namespaces
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Ensure all required KV namespaces exist
          wrangler kv:namespace create "IDENTITIES" 2>/dev/null || echo "Exists"
          wrangler kv:namespace create "RATE_LIMITS" 2>/dev/null || echo "Exists"
          wrangler kv:namespace create "SESSIONS" 2>/dev/null || echo "Exists"
          wrangler kv:namespace create "AGENT_STATE" 2>/dev/null || echo "Exists"
          wrangler kv:namespace create "MESH_ROUTING" 2>/dev/null || echo "Exists"

  sync-railway-services:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Sync Railway environment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Set shared environment variables across Railway services
          railway variables set CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          railway variables set NODE_ENV="production"
          railway variables set BLACKROAD_ENV="production"

  verify-endpoints:
    needs: [sync-cloudflare-kv, sync-railway-services]
    runs-on: ubuntu-latest
    steps:
      - name: Health check all endpoints
        run: |
          endpoints=(
            "https://api.blackroad.io/health"
            "https://status.blackroad.io/health"
            "https://billing.blackroad.io/health"
          )

          for endpoint in "${endpoints[@]}"; do
            echo "Checking $endpoint..."
            curl -sf "$endpoint" && echo " OK" || echo " FAILED (may not be deployed yet)"
          done

      - name: Report status
        run: |
          curl -X POST https://api.blackroad.io/webhooks/infra-sync \
            -H "Content-Type: application/json" \
            -H "X-Deploy-Secret: ${{ secrets.DEPLOY_WEBHOOK_SECRET }}" \
            -d '{
              "event": "infrastructure_sync",
              "status": "completed",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }' || echo "API not available"
