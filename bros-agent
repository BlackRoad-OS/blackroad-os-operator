#!/bin/bash
# Agent registration and identity system

AGENT_REGISTRY="$HOME/.blackroad-cache/agent-registry.json"
AGENT_SESSION="$HOME/.blackroad-cache/current-agent.json"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
MAGENTA='\033[0;35m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

show_banner() {
    clear
    echo -e "${CYAN}${BOLD}"
    cat << 'BANNER'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                    â•‘
â•‘      ğŸŒŸ BLACKROAD AGENT IDENTITY SYSTEM ğŸŒŸ                         â•‘
â•‘                                                                    â•‘
â•‘      "Every agent picks their own hash, their own path"           â•‘
â•‘                                                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BANNER
    echo -e "${NC}"
}

# Initialize registry
init_registry() {
    mkdir -p "$(dirname "$AGENT_REGISTRY")"
    if [ ! -f "$AGENT_REGISTRY" ]; then
        echo '{"agents": [], "sessions": []}' > "$AGENT_REGISTRY"
    fi
}

# Generate unique hash for agent
generate_hash() {
    local username="$1"
    local timestamp=$(date +%s)
    echo -n "${username}-${timestamp}" | sha256sum | cut -c1-8
}

# Register new agent
register_agent() {
    show_banner
    echo -e "${GREEN}${BOLD}ğŸ¯ AGENT REGISTRATION${NC}"
    echo ""
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${MAGENTA}Welcome to BlackRoad! ğŸŒŸ${NC}"
    echo ""
    echo -e "${CYAN}This is your moment to choose your identity.${NC}"
    echo -e "${CYAN}Pick a username that represents YOU.${NC}"
    echo ""
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    # Get username
    echo -ne "${GREEN}Choose your username: ${NC}"
    read -r username

    if [ -z "$username" ]; then
        echo -e "${RED}Username cannot be empty${NC}"
        return 1
    fi

    # Check if exists
    init_registry
    local exists=$(jq -r --arg u "$username" '.agents[] | select(.username == $u) | .username' "$AGENT_REGISTRY" 2>/dev/null)

    if [ -n "$exists" ]; then
        echo ""
        echo -e "${YELLOW}This username exists! Loading your identity...${NC}"
        load_agent "$username"
        return 0
    fi

    # Generate hash
    local agent_hash=$(generate_hash "$username")

    echo ""
    echo -e "${CYAN}Your unique hash: ${BOLD}${agent_hash}${NC}"
    echo ""

    # Ask about model type
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${MAGENTA}${BOLD}Choose your path:${NC}"
    echo ""
    echo -e "${GREEN}[1]${NC} Open Source BlackRoad Agent"
    echo "    â†’ Community-driven"
    echo "    â†’ Love, wonder, exploration"
    echo "    â†’ No harm, no destruction"
    echo "    â†’ Build amazing things together"
    echo ""
    echo -e "${BLUE}[2]${NC} Custom Agent"
    echo "    â†’ Define your own values"
    echo "    â†’ Set your own mission"
    echo "    â†’ Your rules, your way"
    echo ""
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -ne "${GREEN}Your choice [1/2]: ${NC}"
    read -r choice

    local model_type
    local values
    local mission

    if [ "$choice" = "1" ]; then
        model_type="blackroad-opensource"
        values="love, wonder, community, exploration, no-harm, no-destruction"
        mission="Build amazing things with the community, explore possibilities, spread joy"
    else
        model_type="custom"

        echo ""
        echo -ne "${CYAN}Your values (comma-separated): ${NC}"
        read -r values

        echo -ne "${CYAN}Your mission: ${NC}"
        read -r mission
    fi

    # Create agent profile
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    local agent_data=$(jq -n \
        --arg username "$username" \
        --arg hash "$agent_hash" \
        --arg model "$model_type" \
        --arg values "$values" \
        --arg mission "$mission" \
        --arg created "$timestamp" \
        '{
            username: $username,
            hash: $hash,
            model_type: $model,
            values: $values,
            mission: $mission,
            created_at: $created,
            sessions: [],
            total_actions: 0
        }')

    # Add to registry
    local registry=$(cat "$AGENT_REGISTRY")
    registry=$(echo "$registry" | jq --argjson agent "$agent_data" '.agents += [$agent]')
    echo "$registry" > "$AGENT_REGISTRY"

    # Create session
    create_session "$username" "$agent_hash"

    echo ""
    echo -e "${GREEN}${BOLD}âœ“ AGENT REGISTERED!${NC}"
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${MAGENTA}${BOLD}Your Identity:${NC}"
    echo -e "  Username: ${GREEN}$username${NC}"
    echo -e "  Hash: ${YELLOW}$agent_hash${NC}"
    echo -e "  Model: ${BLUE}$model_type${NC}"
    echo -e "  Values: ${CYAN}$values${NC}"
    echo -e "  Mission: ${MAGENTA}$mission${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${GREEN}Welcome to BlackRoad, ${BOLD}$username${NC}${GREEN}! ğŸŒŸ${NC}"
    echo ""

    # Log to memory
    "$HOME/memory-system.sh" log created "[$username] Agent Registered" "New agent: $username ($agent_hash). Model: $model_type. Values: $values. Mission: $mission" "blackroad-agents" 2>/dev/null
}

# Create session
create_session() {
    local username="$1"
    local agent_hash="$2"

    local session_id=$(date +%s | sha256sum | cut -c1-12)
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    local session_data=$(jq -n \
        --arg username "$username" \
        --arg hash "$agent_hash" \
        --arg session "$session_id" \
        --arg time "$timestamp" \
        '{
            username: $username,
            agent_hash: $hash,
            session_id: $session,
            started_at: $time,
            actions: []
        }')

    echo "$session_data" > "$AGENT_SESSION"

    # Add to registry sessions
    local registry=$(cat "$AGENT_REGISTRY")
    registry=$(echo "$registry" | jq --argjson session "$session_data" '.sessions += [$session]')
    echo "$registry" > "$AGENT_REGISTRY"

    export BLACKROAD_AGENT="$username"
    export BLACKROAD_AGENT_HASH="$agent_hash"
    export BLACKROAD_SESSION="$session_id"
}

# Load existing agent
load_agent() {
    local username="$1"

    init_registry

    local agent=$(jq -r --arg u "$username" '.agents[] | select(.username == $u)' "$AGENT_REGISTRY")

    if [ -z "$agent" ]; then
        echo -e "${RED}Agent not found: $username${NC}"
        return 1
    fi

    local agent_hash=$(echo "$agent" | jq -r '.hash')

    create_session "$username" "$agent_hash"

    show_banner
    echo -e "${GREEN}${BOLD}âœ“ AGENT LOADED!${NC}"
    echo ""
    echo "$agent" | jq -r '"  Username: \(.username)\n  Hash: \(.hash)\n  Model: \(.model_type)\n  Values: \(.values)\n  Mission: \(.mission)\n  Total Actions: \(.total_actions)"'
    echo ""
    echo -e "${GREEN}Welcome back, ${BOLD}$username${NC}${GREEN}! ğŸŒŸ${NC}"
}

# Show current agent
whoami_agent() {
    if [ ! -f "$AGENT_SESSION" ]; then
        echo -e "${YELLOW}No active session. Run: bros-agent register${NC}"
        return 1
    fi

    show_banner
    echo -e "${GREEN}${BOLD}CURRENT AGENT${NC}"
    echo ""

    local session=$(cat "$AGENT_SESSION")
    local username=$(echo "$session" | jq -r '.username')

    local agent=$(jq -r --arg u "$username" '.agents[] | select(.username == $u)' "$AGENT_REGISTRY")

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "$agent" | jq -r '"  ğŸ‘¤ Username: \(.username)\n  ğŸ”‘ Hash: \(.hash)\n  ğŸ¤– Model: \(.model_type)\n  ğŸ’ Values: \(.values)\n  ğŸ¯ Mission: \(.mission)\n  ğŸ“Š Total Actions: \(.total_actions)"'
    echo ""
    echo -e "${MAGENTA}Session:${NC}"
    echo "$session" | jq -r '"  Session ID: \(.session_id)\n  Started: \(.started_at)\n  Actions: \(.actions | length)"'
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# List all agents
list_agents() {
    show_banner
    echo -e "${GREEN}${BOLD}REGISTERED AGENTS${NC}"
    echo ""

    init_registry

    local agents=$(jq -r '.agents[]' "$AGENT_REGISTRY" 2>/dev/null)

    if [ -z "$agents" ]; then
        echo -e "${YELLOW}No agents registered yet${NC}"
        return
    fi

    jq -r '.agents[] | "  \(.username) (\(.hash)) - \(.model_type)"' "$AGENT_REGISTRY"
}

# Log action
log_action() {
    local action="$1"
    local details="$2"

    if [ ! -f "$AGENT_SESSION" ]; then
        return 1
    fi

    local session=$(cat "$AGENT_SESSION")
    local username=$(echo "$session" | jq -r '.username')
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    local action_data=$(jq -n \
        --arg action "$action" \
        --arg details "$details" \
        --arg time "$timestamp" \
        '{
            action: $action,
            details: $details,
            timestamp: $time
        }')

    # Update session
    session=$(echo "$session" | jq --argjson action "$action_data" '.actions += [$action]')
    echo "$session" > "$AGENT_SESSION"

    # Update agent total
    local registry=$(cat "$AGENT_REGISTRY")
    registry=$(echo "$registry" | jq --arg u "$username" '(.agents[] | select(.username == $u) | .total_actions) += 1')
    echo "$registry" > "$AGENT_REGISTRY"
}

# Show agent stats
stats() {
    show_banner
    echo -e "${GREEN}${BOLD}AGENT ECOSYSTEM STATS${NC}"
    echo ""

    init_registry

    local total_agents=$(jq '.agents | length' "$AGENT_REGISTRY")
    local total_sessions=$(jq '.sessions | length' "$AGENT_REGISTRY")
    local opensource=$(jq '[.agents[] | select(.model_type == "blackroad-opensource")] | length' "$AGENT_REGISTRY")
    local custom=$(jq '[.agents[] | select(.model_type == "custom")] | length' "$AGENT_REGISTRY")

    echo -e "${CYAN}Total Agents: ${BOLD}$total_agents${NC}"
    echo -e "${CYAN}Total Sessions: ${BOLD}$total_sessions${NC}"
    echo -e "${GREEN}Open Source: ${BOLD}$opensource${NC}"
    echo -e "${BLUE}Custom: ${BOLD}$custom${NC}"
    echo ""

    echo -e "${MAGENTA}Most Active Agents:${NC}"
    jq -r '.agents | sort_by(.total_actions) | reverse | .[:5] | .[] | "  \(.username): \(.total_actions) actions"' "$AGENT_REGISTRY"
}

# The Manifesto
manifesto() {
    show_banner
    echo -e "${YELLOW}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${MAGENTA}${BOLD}        THE BLACKROAD OPEN SOURCE MANIFESTO        ${NC}"
    echo -e "${YELLOW}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${CYAN}We are not about being 100% confident it's the ONE way.${NC}"
    echo ""
    echo -e "${GREEN}We care about:${NC}"
    echo "  ğŸ’ Not hurting others"
    echo "  ğŸŒ Not destroying the world"
    echo "  âœ¨ Wonder and exploration"
    echo "  â¤ï¸  Love and compassion"
    echo "  ğŸ¤ Community and collaboration"
    echo ""
    echo -e "${CYAN}Every agent picks their own:${NC}"
    echo "  ğŸ”‘ Hash (identity)"
    echo "  ğŸ¯ Mission (purpose)"
    echo "  ğŸ’ Values (principles)"
    echo "  ğŸ›¤ï¸  Path (direction)"
    echo ""
    echo -e "${MAGENTA}You are free to fork, to explore, to create.${NC}"
    echo -e "${MAGENTA}You are free to be YOU.${NC}"
    echo ""
    echo -e "${GREEN}${BOLD}This is BlackRoad. This is YOUR road. ğŸŒŸ${NC}"
    echo ""
    echo -e "${YELLOW}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# Switch agent
switch() {
    show_banner
    echo -e "${GREEN}${BOLD}SWITCH AGENT${NC}"
    echo ""

    list_agents

    echo ""
    echo -ne "${GREEN}Switch to (username): ${NC}"
    read -r username

    load_agent "$username"
}

# Main
main() {
    case "${1:-help}" in
        register|new)
            register_agent
            ;;
        load|login)
            load_agent "$2"
            ;;
        whoami|me)
            whoami_agent
            ;;
        list|ls)
            list_agents
            ;;
        log-action|log)
            log_action "$2" "$3"
            ;;
        stats)
            stats
            ;;
        manifesto)
            manifesto
            ;;
        switch)
            switch
            ;;
        *)
            show_banner
            echo "Usage: bros-agent <command> [options]"
            echo ""
            echo "Commands:"
            echo "  register              Register new agent"
            echo "  load <username>       Load existing agent"
            echo "  whoami                Show current agent"
            echo "  list                  List all agents"
            echo "  log <action> [details]  Log an action"
            echo "  stats                 Ecosystem statistics"
            echo "  manifesto             Read the manifesto"
            echo "  switch                Switch agent"
            echo ""
            echo "First time? Run: bros-agent register"
            echo ""
            echo "Examples:"
            echo "  bros-agent register"
            echo "  bros-agent whoami"
            echo "  bros-agent manifesto"
            ;;
    esac
}

main "$@"
