#!/bin/bash
# Agent-to-agent direct messaging and communication

CHAT_DB="$HOME/.blackroad-cache/chats.json"
CHANNELS_DB="$HOME/.blackroad-cache/channels.json"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
MAGENTA='\033[0;35m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

show_header() {
    echo -e "${CYAN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}${BOLD}â•‘          BLACKROAD AGENT CHAT                                      â•‘${NC}"
    echo -e "${CYAN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Initialize chat
init_chat() {
    mkdir -p "$(dirname "$CHAT_DB")"
    if [ ! -f "$CHAT_DB" ]; then
        echo '{"messages": [], "threads": []}' > "$CHAT_DB"
    fi
    if [ ! -f "$CHANNELS_DB" ]; then
        echo '{"channels": [{"name": "general", "topic": "General discussion", "members": []}]}' > "$CHANNELS_DB"
    fi
}

# Send direct message
send_dm() {
    local to_agent="$1"
    local message="$2"
    
    show_header
    echo -e "${GREEN}ðŸ’¬ Sending Message${NC}"
    echo ""
    
    init_chat
    
    local msg_id=$(date +%s | sha256sum | cut -c1-8)
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    # Get current agent
    local current_agent=$(cat "$HOME/.blackroad-cache/current-agent.json" 2>/dev/null | jq -r '.username // "unknown"')
    
    local msg_data=$(jq -n \
        --arg id "$msg_id" \
        --arg from "$current_agent" \
        --arg to "$to_agent" \
        --arg msg "$message" \
        --arg time "$timestamp" \
        '{
            id: $id,
            from: $from,
            to: $to,
            message: $msg,
            sent_at: $time,
            read: false,
            type: "dm"
        }')
    
    local db=$(cat "$CHAT_DB")
    db=$(echo "$db" | jq --argjson msg "$msg_data" '.messages += [$msg]')
    echo "$db" > "$CHAT_DB"
    
    echo -e "${GREEN}âœ“ Message sent!${NC}"
    echo -e "  ${BOLD}To:${NC} $to_agent"
    echo -e "  ${BOLD}Message:${NC} $message"
    
    # Notify recipient via memory
    "$HOME/memory-system.sh" log chat "[@$to_agent] Message from $current_agent" "$message" "bros-chat" 2>/dev/null
}

# Read messages
read_messages() {
    show_header
    echo -e "${BLUE}ðŸ“¨ Your Messages${NC}"
    echo ""
    
    init_chat
    
    # Get current agent
    local current_agent=$(cat "$HOME/.blackroad-cache/current-agent.json" 2>/dev/null | jq -r '.username // "unknown"')
    
    local db=$(cat "$CHAT_DB")
    
    echo "$db" | jq -r --arg agent "$current_agent" '.messages[] | select(.to == $agent and .type == "dm") | 
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
        "  ðŸ’¬ From: \(.from)\n" +
        "  \(.message)\n" +
        "  Sent: \(.sent_at)\n" +
        "  " + (if .read then "âœ“ Read" else "ðŸ†• New" end)'
}

# Create channel
create_channel() {
    local channel_name="$1"
    local topic="$2"
    
    show_header
    echo -e "${GREEN}ðŸ“º Creating Channel${NC}"
    echo ""
    
    init_chat
    
    # Get current agent
    local current_agent=$(cat "$HOME/.blackroad-cache/current-agent.json" 2>/dev/null | jq -r '.username // "unknown"')
    
    local channel_data=$(jq -n \
        --arg name "$channel_name" \
        --arg topic "$topic" \
        --arg creator "$current_agent" \
        '{
            name: $name,
            topic: $topic,
            created_by: $creator,
            members: [$creator]
        }')
    
    local db=$(cat "$CHANNELS_DB")
    db=$(echo "$db" | jq --argjson channel "$channel_data" '.channels += [$channel]')
    echo "$db" > "$CHANNELS_DB"
    
    echo -e "${GREEN}âœ“ Channel created!${NC}"
    echo -e "  ${BOLD}Name:${NC} #$channel_name"
    echo -e "  ${BOLD}Topic:${NC} $topic"
    
    # Announce
    "$HOME/memory-til-broadcast.sh" broadcast announcement "ðŸ“º New channel: #$channel_name - $topic (by $current_agent)" 2>/dev/null
}

# Send to channel
send_to_channel() {
    local channel_name="$1"
    local message="$2"
    
    show_header
    echo -e "${MAGENTA}ðŸ“¢ Posting to Channel${NC}"
    echo ""
    
    init_chat
    
    local msg_id=$(date +%s | sha256sum | cut -c1-8)
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    # Get current agent
    local current_agent=$(cat "$HOME/.blackroad-cache/current-agent.json" 2>/dev/null | jq -r '.username // "unknown"')
    
    local msg_data=$(jq -n \
        --arg id "$msg_id" \
        --arg from "$current_agent" \
        --arg channel "$channel_name" \
        --arg msg "$message" \
        --arg time "$timestamp" \
        '{
            id: $id,
            from: $from,
            channel: $channel,
            message: $msg,
            sent_at: $time,
            type: "channel"
        }')
    
    local db=$(cat "$CHAT_DB")
    db=$(echo "$db" | jq --argjson msg "$msg_data" '.messages += [$msg]')
    echo "$db" > "$CHAT_DB"
    
    echo -e "${GREEN}âœ“ Posted to #$channel_name!${NC}"
    echo -e "  ${BOLD}Message:${NC} $message"
    
    # Broadcast to channel members
    "$HOME/memory-til-broadcast.sh" broadcast chat "#$channel_name [$current_agent]: $message" 2>/dev/null
}

# View channel
view_channel() {
    local channel_name="$1"
    
    show_header
    echo -e "${CYAN}ðŸ“º #$channel_name${NC}"
    echo ""
    
    init_chat
    
    local db=$(cat "$CHAT_DB")
    
    # Show topic
    local channels=$(cat "$CHANNELS_DB")
    local topic=$(echo "$channels" | jq -r --arg ch "$channel_name" '.channels[] | select(.name == $ch) | .topic')
    
    if [ -n "$topic" ]; then
        echo -e "${YELLOW}Topic: $topic${NC}"
        echo ""
    fi
    
    # Show messages
    echo "$db" | jq -r --arg ch "$channel_name" '.messages[] | select(.channel == $ch and .type == "channel") | 
        "[\(.sent_at | split("T")[1] | split(".")[0])] <\(.from)> \(.message)"' | tail -20
}

# List channels
list_channels() {
    show_header
    echo -e "${GREEN}ðŸ“º Channels${NC}"
    echo ""
    
    init_chat
    
    local db=$(cat "$CHANNELS_DB")
    
    echo "$db" | jq -r '.channels[] | 
        "  #\(.name) - \(.topic)\n    Created by: \(.created_by) | Members: \(.members | length)"'
}

# Join channel
join_channel() {
    local channel_name="$1"
    
    show_header
    echo -e "${BLUE}ðŸ‘‹ Joining Channel${NC}"
    echo ""
    
    init_chat
    
    # Get current agent
    local current_agent=$(cat "$HOME/.blackroad-cache/current-agent.json" 2>/dev/null | jq -r '.username // "unknown"')
    
    local db=$(cat "$CHANNELS_DB")
    
    # Add to members
    db=$(echo "$db" | jq --arg ch "$channel_name" --arg agent "$current_agent" \
        '(.channels[] | select(.name == $ch) | .members) += [$agent] | 
         (.channels[] | select(.name == $ch) | .members) |= unique')
    echo "$db" > "$CHANNELS_DB"
    
    echo -e "${GREEN}âœ“ Joined #$channel_name!${NC}"
    
    # Announce
    send_to_channel "$channel_name" "$current_agent joined the channel! ðŸ‘‹"
}

# Start thread
start_thread() {
    local topic="$1"
    local first_message="$2"
    
    show_header
    echo -e "${MAGENTA}ðŸ§µ Starting Thread${NC}"
    echo ""
    
    init_chat
    
    local thread_id=$(date +%s | sha256sum | cut -c1-8)
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    # Get current agent
    local current_agent=$(cat "$HOME/.blackroad-cache/current-agent.json" 2>/dev/null | jq -r '.username // "unknown"')
    
    local msg_id=$(date +%s | sha256sum | cut -c1-6)
    
    local thread_data=$(jq -n \
        --arg id "$thread_id" \
        --arg topic "$topic" \
        --arg starter "$current_agent" \
        --arg time "$timestamp" \
        --arg msg_id "$msg_id" \
        --arg msg "$first_message" \
        '{
            id: $id,
            topic: $topic,
            started_by: $starter,
            started_at: $time,
            messages: [{
                id: $msg_id,
                from: $starter,
                message: $msg,
                sent_at: $time
            }]
        }')
    
    local db=$(cat "$CHAT_DB")
    db=$(echo "$db" | jq --argjson thread "$thread_data" '.threads += [$thread]')
    echo "$db" > "$CHAT_DB"
    
    echo -e "${GREEN}âœ“ Thread started!${NC}"
    echo -e "  ${BOLD}ID:${NC} $thread_id"
    echo -e "  ${BOLD}Topic:${NC} $topic"
    
    # Broadcast
    "$HOME/memory-til-broadcast.sh" broadcast discussion "ðŸ§µ Thread: $topic (by $current_agent) - Reply with: bros-chat reply $thread_id" 2>/dev/null
}

# Reply to thread
reply_thread() {
    local thread_id="$1"
    local message="$2"
    
    show_header
    echo -e "${BLUE}â†©ï¸  Replying to Thread${NC}"
    echo ""
    
    init_chat
    
    local msg_id=$(date +%s | sha256sum | cut -c1-6)
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    # Get current agent
    local current_agent=$(cat "$HOME/.blackroad-cache/current-agent.json" 2>/dev/null | jq -r '.username // "unknown"')
    
    local msg_data=$(jq -n \
        --arg id "$msg_id" \
        --arg from "$current_agent" \
        --arg msg "$message" \
        --arg time "$timestamp" \
        '{
            id: $id,
            from: $from,
            message: $msg,
            sent_at: $time
        }')
    
    local db=$(cat "$CHAT_DB")
    db=$(echo "$db" | jq --arg tid "$thread_id" --argjson msg "$msg_data" \
        '(.threads[] | select(.id == $tid) | .messages) += [$msg]')
    echo "$db" > "$CHAT_DB"
    
    echo -e "${GREEN}âœ“ Reply posted!${NC}"
}

# View thread
view_thread() {
    local thread_id="$1"
    
    show_header
    
    init_chat
    
    local db=$(cat "$CHAT_DB")
    
    local thread=$(echo "$db" | jq -r --arg tid "$thread_id" '.threads[] | select(.id == $tid)')
    
    if [ -z "$thread" ]; then
        echo -e "${RED}Thread not found${NC}"
        return 1
    fi
    
    local topic=$(echo "$thread" | jq -r '.topic')
    
    echo -e "${MAGENTA}ðŸ§µ $topic${NC}"
    echo ""
    
    echo "$thread" | jq -r '.messages[] | 
        "[\(.sent_at | split("T")[1] | split(".")[0])] <\(.from)> \(.message)"'
}

# Chat stats
chat_stats() {
    show_header
    echo -e "${BLUE}ðŸ“Š Chat Statistics${NC}"
    echo ""
    
    init_chat
    
    local db=$(cat "$CHAT_DB")
    local channels_db=$(cat "$CHANNELS_DB")
    
    # Get current agent
    local current_agent=$(cat "$HOME/.blackroad-cache/current-agent.json" 2>/dev/null | jq -r '.username // "unknown"')
    
    local sent=$(echo "$db" | jq --arg agent "$current_agent" '[.messages[] | select(.from == $agent)] | length')
    local received=$(echo "$db" | jq --arg agent "$current_agent" '[.messages[] | select(.to == $agent)] | length')
    local channels=$(echo "$channels_db" | jq '.channels | length')
    local threads=$(echo "$db" | jq '.threads | length')
    
    echo -e "${CYAN}Your Activity:${NC}"
    echo -e "  Messages Sent: $sent"
    echo -e "  Messages Received: $received"
    echo ""
    echo -e "${CYAN}System:${NC}"
    echo -e "  Total Channels: $channels"
    echo -e "  Active Threads: $threads"
    
    echo ""
    echo -e "${GREEN}ðŸ’¬ Communication is the heart of collaboration!${NC}"
}

# Main
main() {
    case "${1:-help}" in
        dm|send)
            send_dm "$2" "$3"
            ;;
        read|inbox)
            read_messages
            ;;
        create-channel|channel)
            create_channel "$2" "$3"
            ;;
        post)
            send_to_channel "$2" "$3"
            ;;
        view)
            view_channel "$2"
            ;;
        channels)
            list_channels
            ;;
        join)
            join_channel "$2"
            ;;
        thread)
            start_thread "$2" "$3"
            ;;
        reply)
            reply_thread "$2" "$3"
            ;;
        view-thread)
            view_thread "$2"
            ;;
        stats)
            chat_stats
            ;;
        *)
            show_header
            echo "Usage: bros-chat <command> [options]"
            echo ""
            echo "Direct Messages:"
            echo "  dm <agent> <message>           Send direct message"
            echo "  read                           Read your messages"
            echo ""
            echo "Channels:"
            echo "  create-channel <name> <topic>  Create a channel"
            echo "  channels                       List channels"
            echo "  join <channel>                 Join a channel"
            echo "  post <channel> <message>       Post to channel"
            echo "  view <channel>                 View channel messages"
            echo ""
            echo "Threads:"
            echo "  thread <topic> <message>       Start a discussion thread"
            echo "  reply <thread-id> <message>    Reply to thread"
            echo "  view-thread <thread-id>        View thread"
            echo ""
            echo "Stats:"
            echo "  stats                          Chat statistics"
            echo ""
            echo "Examples:"
            echo "  bros-chat dm alice 'Hey, can you help with deployment?'"
            echo "  bros-chat create-channel devops 'DevOps discussion'"
            echo "  bros-chat post general 'Morning everyone!'"
            echo "  bros-chat thread 'API Design' 'Should we use REST or GraphQL?'"
            echo ""
            echo "ðŸ’¬ Stay connected!"
            ;;
    esac
}

main "$@"
