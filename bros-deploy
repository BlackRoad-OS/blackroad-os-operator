#!/bin/bash
# Deployment automation for BlackRoad repos

CACHE_FILE="$HOME/.blackroad-cache/repos.json"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
MAGENTA='\033[0;35m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

show_header() {
    echo -e "${CYAN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}${BOLD}â•‘          BLACKROAD DEPLOYMENT AUTOMATION                           â•‘${NC}"
    echo -e "${CYAN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Quick deploy to Railway
deploy_railway() {
    local repo="$1"

    show_header
    echo -e "${GREEN}ðŸš‚ Railway Deployment: $repo${NC}"
    echo ""

    if [ ! -d "$repo" ]; then
        echo -e "${RED}Error: Directory $repo not found${NC}"
        echo -e "${YELLOW}Run: bros clone $repo${NC}"
        return 1
    fi

    cd "$repo"

    echo -e "${CYAN}Checking for railway.toml...${NC}"
    if [ ! -f "railway.toml" ]; then
        echo -e "${YELLOW}No railway.toml found. Creating default...${NC}"
        cat > railway.toml << 'RAILWAY'
[build]
builder = "nixpacks"

[deploy]
startCommand = "npm start"
healthcheckPath = "/health"
healthcheckTimeout = 300
restartPolicyType = "on-failure"
restartPolicyMaxRetries = 10
RAILWAY
        echo -e "${GREEN}âœ“ Created railway.toml${NC}"
    fi

    echo ""
    echo -e "${CYAN}Deploying to Railway...${NC}"
    railway up

    echo ""
    echo -e "${GREEN}âœ“ Deployment initiated!${NC}"
    echo -e "${YELLOW}Check status: railway status${NC}"
    echo -e "${YELLOW}View logs: railway logs${NC}"
}

# Deploy to Cloudflare Pages
deploy_cloudflare() {
    local repo="$1"

    show_header
    echo -e "${GREEN}â˜ï¸  Cloudflare Pages Deployment: $repo${NC}"
    echo ""

    if [ ! -d "$repo" ]; then
        echo -e "${RED}Error: Directory $repo not found${NC}"
        echo -e "${YELLOW}Run: bros clone $repo${NC}"
        return 1
    fi

    cd "$repo"

    # Detect build directory
    local build_dir="dist"
    if [ -d "build" ]; then build_dir="build"; fi
    if [ -d "out" ]; then build_dir="out"; fi
    if [ -d "public" ]; then build_dir="public"; fi

    echo -e "${CYAN}Build directory: $build_dir${NC}"
    echo ""

    # Build if needed
    if [ -f "package.json" ]; then
        echo -e "${YELLOW}Building project...${NC}"
        npm run build || pnpm build || yarn build
    fi

    echo ""
    echo -e "${CYAN}Deploying to Cloudflare Pages...${NC}"
    wrangler pages deploy "$build_dir" --project-name "$repo"

    echo ""
    echo -e "${GREEN}âœ“ Deployed to Cloudflare Pages!${NC}"
}

# Deploy Cloudflare Worker
deploy_worker() {
    local repo="$1"

    show_header
    echo -e "${GREEN}âš¡ Cloudflare Worker Deployment: $repo${NC}"
    echo ""

    if [ ! -d "$repo" ]; then
        echo -e "${RED}Error: Directory $repo not found${NC}"
        return 1
    fi

    cd "$repo"

    if [ ! -f "wrangler.toml" ]; then
        echo -e "${RED}No wrangler.toml found${NC}"
        return 1
    fi

    echo -e "${CYAN}Deploying worker...${NC}"
    wrangler deploy

    echo ""
    echo -e "${GREEN}âœ“ Worker deployed!${NC}"
}

# Multi-deploy (deploy to multiple environments)
multi_deploy() {
    local pattern="$1"
    local repos=$(cat "$CACHE_FILE")

    show_header
    echo -e "${GREEN}ðŸŽ¯ Multi-Deploy: $pattern${NC}"
    echo ""

    local matches=$(echo "$repos" | jq -r --arg p "$pattern" '.[] | select(.name | ascii_downcase | contains($p | ascii_downcase)) | .name')

    if [ -z "$matches" ]; then
        echo -e "${RED}No repos match: $pattern${NC}"
        return 1
    fi

    echo -e "${CYAN}Found repos:${NC}"
    echo "$matches" | while read -r name; do
        echo "  â†’ $name"
    done

    echo ""
    echo -e "${YELLOW}Deploy all? (y/N)${NC}"
    read -r confirm

    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        echo "$matches" | while read -r name; do
            echo ""
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${GREEN}Deploying: $name${NC}"
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

            # Auto-detect deployment type
            if [ -d "$name/workers" ]; then
                deploy_worker "$name"
            elif grep -q "railway" "$name/package.json" 2>/dev/null; then
                deploy_railway "$name"
            else
                deploy_cloudflare "$name"
            fi
        done

        echo ""
        echo -e "${GREEN}âœ“ Multi-deploy complete!${NC}"
    fi
}

# Check deployment status
check_status() {
    show_header
    echo -e "${GREEN}ðŸ“Š Deployment Status${NC}"
    echo ""

    # Railway
    echo -e "${CYAN}Railway Projects:${NC}"
    railway list 2>/dev/null || echo "  (railway CLI not configured)"
    echo ""

    # Cloudflare Pages
    echo -e "${CYAN}Cloudflare Pages:${NC}"
    wrangler pages project list 2>/dev/null || echo "  (wrangler not configured)"
    echo ""

    # Cloudflare Workers
    echo -e "${CYAN}Cloudflare Workers:${NC}"
    wrangler deployments list 2>/dev/null || echo "  (wrangler not configured)"
    echo ""
}

# Rollback deployment
rollback() {
    local service="$1"

    show_header
    echo -e "${YELLOW}â®ï¸  Rollback: $service${NC}"
    echo ""

    echo -e "${RED}This will rollback to the previous deployment${NC}"
    echo -e "${YELLOW}Continue? (y/N)${NC}"
    read -r confirm

    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        # Try Railway first
        railway rollback "$service" 2>/dev/null && echo -e "${GREEN}âœ“ Rolled back on Railway${NC}" && return

        # Try Cloudflare
        wrangler rollback "$service" 2>/dev/null && echo -e "${GREEN}âœ“ Rolled back on Cloudflare${NC}" && return

        echo -e "${RED}Could not rollback. Check service name.${NC}"
    fi
}

# Main menu
main() {
    case "${1:-help}" in
        railway)
            deploy_railway "${2:-.}"
            ;;
        cloudflare|cf)
            deploy_cloudflare "${2:-.}"
            ;;
        worker)
            deploy_worker "${2:-.}"
            ;;
        multi)
            multi_deploy "$2"
            ;;
        status)
            check_status
            ;;
        rollback)
            rollback "$2"
            ;;
        *)
            echo "Usage: bros-deploy <command> [options]"
            echo ""
            echo "Commands:"
            echo "  railway <repo>     Deploy to Railway"
            echo "  cloudflare <repo>  Deploy to Cloudflare Pages"
            echo "  worker <repo>      Deploy Cloudflare Worker"
            echo "  multi <pattern>    Deploy multiple repos matching pattern"
            echo "  status             Check deployment status"
            echo "  rollback <service> Rollback a deployment"
            echo ""
            echo "Examples:"
            echo "  bros-deploy railway blackroad-os-operator"
            echo "  bros-deploy cloudflare blackroad-os-dashboard"
            echo "  bros-deploy multi dashboard"
            echo "  bros-deploy status"
            ;;
    esac
}

main "$@"
