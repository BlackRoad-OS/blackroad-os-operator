#!/bin/bash
# Dependency scanning and management

CACHE_FILE="$HOME/.blackroad-cache/repos.json"
LOCAL_DIR="${BLACKROAD_LOCAL_DIR:-$HOME/blackroad-repos}"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
MAGENTA='\033[0;35m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

show_header() {
    echo -e "${CYAN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}${BOLD}â•‘          BLACKROAD DEPENDENCY SCANNER                              â•‘${NC}"
    echo -e "${CYAN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Scan for package.json dependencies
scan_npm() {
    local pattern="${1:-.}"

    show_header
    echo -e "${GREEN}ðŸ“¦ NPM Dependencies${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local matches=$(echo "$repos" | jq -r --arg p "$pattern" '.[] | select(.name | ascii_downcase | contains($p | ascii_downcase)) | .name')

    echo "$matches" | while read -r name; do
        if [ -f "$LOCAL_DIR/$name/package.json" ]; then
            echo -e "${CYAN}${BOLD}$name:${NC}"

            local deps=$(jq -r '.dependencies // {} | to_entries | .[] | "\(.key)@\(.value)"' "$LOCAL_DIR/$name/package.json" 2>/dev/null)
            local dev_deps=$(jq -r '.devDependencies // {} | to_entries | .[] | "\(.key)@\(.value)"' "$LOCAL_DIR/$name/package.json" 2>/dev/null)

            if [ -n "$deps" ]; then
                echo -e "  ${GREEN}Dependencies:${NC}"
                echo "$deps" | while read -r dep; do
                    echo "    â†’ $dep"
                done
            fi

            if [ -n "$dev_deps" ]; then
                echo -e "  ${YELLOW}Dev Dependencies:${NC}"
                echo "$dev_deps" | head -5 | while read -r dep; do
                    echo "    â†’ $dep"
                done
                local count=$(echo "$dev_deps" | wc -l | tr -d ' ')
                if [ "$count" -gt 5 ]; then
                    echo "    ... and $((count - 5)) more"
                fi
            fi

            echo ""
        fi
    done
}

# Scan for requirements.txt/pyproject.toml
scan_python() {
    local pattern="${1:-.}"

    show_header
    echo -e "${GREEN}ðŸ Python Dependencies${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local matches=$(echo "$repos" | jq -r --arg p "$pattern" '.[] | select(.name | ascii_downcase | contains($p | ascii_downcase)) | .name')

    echo "$matches" | while read -r name; do
        if [ -f "$LOCAL_DIR/$name/requirements.txt" ]; then
            echo -e "${CYAN}${BOLD}$name (requirements.txt):${NC}"
            cat "$LOCAL_DIR/$name/requirements.txt" | grep -v '^#' | grep -v '^$' | while read -r dep; do
                echo "  â†’ $dep"
            done
            echo ""
        elif [ -f "$LOCAL_DIR/$name/pyproject.toml" ]; then
            echo -e "${CYAN}${BOLD}$name (pyproject.toml):${NC}"
            echo "  (pyproject.toml found - use poetry show for details)"
            echo ""
        fi
    done
}

# Find common dependencies
find_common() {
    local dep_name="$1"
    local pattern="${2:-.}"

    show_header
    echo -e "${GREEN}ðŸ” Repos using: $dep_name${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local matches=$(echo "$repos" | jq -r --arg p "$pattern" '.[] | select(.name | ascii_downcase | contains($p | ascii_downcase)) | .name')

    local found=0

    echo "$matches" | while read -r name; do
        # Check package.json
        if [ -f "$LOCAL_DIR/$name/package.json" ]; then
            local has_dep=$(jq -r --arg dep "$dep_name" '.dependencies[$dep] // .devDependencies[$dep] // empty' "$LOCAL_DIR/$name/package.json" 2>/dev/null)
            if [ -n "$has_dep" ]; then
                echo -e "${GREEN}âœ“${NC} $name: $dep_name@$has_dep"
                ((found++))
            fi
        fi

        # Check requirements.txt
        if [ -f "$LOCAL_DIR/$name/requirements.txt" ]; then
            local has_dep=$(grep -i "^$dep_name" "$LOCAL_DIR/$name/requirements.txt" 2>/dev/null)
            if [ -n "$has_dep" ]; then
                echo -e "${GREEN}âœ“${NC} $name: $has_dep"
                ((found++))
            fi
        fi
    done

    echo ""
    echo -e "${CYAN}Total repos using $dep_name: $found${NC}"
}

# Check for outdated dependencies
check_outdated() {
    local pattern="${1:-.}"

    show_header
    echo -e "${GREEN}â° Checking for Outdated Packages${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local matches=$(echo "$repos" | jq -r --arg p "$pattern" '.[] | select(.name | ascii_downcase | contains($p | ascii_downcase)) | .name')

    echo "$matches" | while read -r name; do
        if [ -f "$LOCAL_DIR/$name/package.json" ]; then
            echo -e "${CYAN}$name:${NC}"

            cd "$LOCAL_DIR/$name"

            # Check if node_modules exists
            if [ -d "node_modules" ]; then
                local outdated=$(npm outdated --json 2>/dev/null)
                if [ -n "$outdated" ] && [ "$outdated" != "{}" ]; then
                    echo "$outdated" | jq -r 'to_entries | .[] | "  \(.key): \(.value.current) â†’ \(.value.latest)"'
                else
                    echo -e "  ${GREEN}âœ“ All packages up to date${NC}"
                fi
            else
                echo -e "  ${YELLOW}(node_modules not found - run npm install)${NC}"
            fi

            echo ""
        fi
    done
}

# Update all dependencies
update_deps() {
    local pattern="${1:-.}"

    show_header
    echo -e "${GREEN}â¬†ï¸  Updating Dependencies${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local matches=$(echo "$repos" | jq -r --arg p "$pattern" '.[] | select(.name | ascii_downcase | contains($p | ascii_downcase)) | .name')

    if [ -z "$matches" ]; then
        echo -e "${RED}No repos match: $pattern${NC}"
        return 1
    fi

    echo -e "${CYAN}Updating deps in:${NC}"
    echo "$matches" | while read -r name; do
        echo "  â†’ $name"
    done

    echo ""
    echo -e "${YELLOW}Update all? (y/N)${NC}"
    read -r confirm

    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        echo "$matches" | while read -r name; do
            echo -e "${CYAN}$name:${NC}"

            if [ -f "$LOCAL_DIR/$name/package.json" ]; then
                cd "$LOCAL_DIR/$name"
                echo "  Running npm update..."
                npm update 2>&1 | grep -E "(added|updated|removed)" || echo "  No changes"
            elif [ -f "$LOCAL_DIR/$name/requirements.txt" ]; then
                cd "$LOCAL_DIR/$name"
                echo "  Running pip install --upgrade..."
                pip install --upgrade -r requirements.txt 2>&1 | tail -5
            fi

            echo ""
        done

        echo -e "${GREEN}âœ“ Updates complete${NC}"
    fi
}

# Scan for security vulnerabilities
security_scan() {
    local pattern="${1:-.}"

    show_header
    echo -e "${GREEN}ðŸ”’ Security Vulnerability Scan${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local matches=$(echo "$repos" | jq -r --arg p "$pattern" '.[] | select(.name | ascii_downcase | contains($p | ascii_downcase)) | .name')

    echo "$matches" | while read -r name; do
        if [ -f "$LOCAL_DIR/$name/package.json" ]; then
            echo -e "${CYAN}${BOLD}$name:${NC}"

            cd "$LOCAL_DIR/$name"

            # npm audit
            local audit=$(npm audit --json 2>/dev/null)
            if [ -n "$audit" ]; then
                local critical=$(echo "$audit" | jq -r '.metadata.vulnerabilities.critical // 0')
                local high=$(echo "$audit" | jq -r '.metadata.vulnerabilities.high // 0')
                local moderate=$(echo "$audit" | jq -r '.metadata.vulnerabilities.moderate // 0')

                if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
                    echo -e "  ${RED}âš  CRITICAL: $critical | HIGH: $high | MODERATE: $moderate${NC}"
                elif [ "$moderate" -gt 0 ]; then
                    echo -e "  ${YELLOW}MODERATE: $moderate vulnerabilities${NC}"
                else
                    echo -e "  ${GREEN}âœ“ No vulnerabilities${NC}"
                fi
            fi

            echo ""
        fi
    done
}

# Dependency graph summary
dep_summary() {
    local pattern="${1:-.}"

    show_header
    echo -e "${GREEN}ðŸ“Š Dependency Summary${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local matches=$(echo "$repos" | jq -r --arg p "$pattern" '.[] | select(.name | ascii_downcase | contains($p | ascii_downcase)) | .name')

    local npm_repos=0
    local python_repos=0
    local total_deps=0

    declare -A dep_counts

    echo "$matches" | while read -r name; do
        if [ -f "$LOCAL_DIR/$name/package.json" ]; then
            ((npm_repos++))
            local count=$(jq -r '(.dependencies // {} | length) + (.devDependencies // {} | length)' "$LOCAL_DIR/$name/package.json" 2>/dev/null)
            ((total_deps += count))

            # Count most common deps
            jq -r '.dependencies // {} | keys[]' "$LOCAL_DIR/$name/package.json" 2>/dev/null | while read -r dep; do
                # Track in subshell
                :
            done
        fi

        if [ -f "$LOCAL_DIR/$name/requirements.txt" ]; then
            ((python_repos++))
        fi
    done

    echo -e "${CYAN}Ecosystem Overview:${NC}"
    echo "  NPM repos: $npm_repos"
    echo "  Python repos: $python_repos"
    echo "  Total NPM deps: ~$total_deps"
    echo ""
}

# Main
main() {
    if [ ! -f "$CACHE_FILE" ]; then
        echo -e "${RED}Error: Cache not found. Run 'bros refresh' first.${NC}"
        exit 1
    fi

    case "${1:-help}" in
        npm|node)
            scan_npm "$2"
            ;;
        python|py)
            scan_python "$2"
            ;;
        find|search)
            find_common "$2" "$3"
            ;;
        outdated)
            check_outdated "$2"
            ;;
        update)
            update_deps "$2"
            ;;
        security|audit)
            security_scan "$2"
            ;;
        summary|stats)
            dep_summary "$2"
            ;;
        *)
            echo "Usage: bros-deps <command> [options]"
            echo ""
            echo "Commands:"
            echo "  npm [pattern]                Scan NPM dependencies"
            echo "  python [pattern]             Scan Python dependencies"
            echo "  find <package> [pattern]     Find repos using a package"
            echo "  outdated [pattern]           Check for outdated packages"
            echo "  update [pattern]             Update all dependencies"
            echo "  security [pattern]           Security vulnerability scan"
            echo "  summary [pattern]            Dependency summary"
            echo ""
            echo "Examples:"
            echo "  bros-deps npm dashboard"
            echo "  bros-deps find react"
            echo "  bros-deps outdated agent"
            echo "  bros-deps security"
            echo ""
            echo "Note: Repos must be cloned locally first (use bros-sync clone)"
            ;;
    esac
}

main "$@"
