#!/bin/bash
# Generate ASCII graphs and visualizations of the ecosystem

CACHE_FILE="$HOME/.blackroad-cache/repos.json"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
MAGENTA='\033[0;35m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

# Generate bar graph
bar_graph() {
    local value=$1
    local max=$2
    local width=50

    local filled=$(( (value * width) / max ))
    local empty=$(( width - filled ))

    printf "${GREEN}"
    for i in $(seq 1 $filled); do printf "█"; done
    printf "${NC}"
    for i in $(seq 1 $empty); do printf "░"; done
}

# Language distribution graph
graph_languages() {
    echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║           LANGUAGE DISTRIBUTION - VISUAL GRAPH                     ║${NC}"
    echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local total=$(echo "$repos" | jq 'length')
    local max=$(echo "$repos" | jq -r '[.[] | .primaryLanguage.name // "Unknown"] | group_by(.) | map(length) | max')

    echo "$repos" | jq -r '[.[] | .primaryLanguage.name // "Unknown"] | group_by(.) | map({lang: .[0], count: length}) | sort_by(.count) | reverse | .[]' | \
    while IFS= read -r line; do
        local lang=$(echo "$line" | jq -r '.lang')
        local count=$(echo "$line" | jq -r '.count')

        printf "%-15s [%3d] " "$lang" "$count"
        bar_graph "$count" "$max"
        printf " %.1f%%\n" $(echo "scale=1; $count * 100 / $total" | bc)
    done

    echo ""
}

# Activity timeline
graph_activity() {
    echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║           ACTIVITY TIMELINE - LAST 14 DAYS                         ║${NC}"
    echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")

    # Get last 14 days of activity
    echo "$repos" | jq -r '[.[] | select(.pushedAt != null) | {date: (.pushedAt | split("T")[0]), name: .name}] | group_by(.date) | map({date: .[0].date, count: length}) | sort_by(.date) | reverse | .[:14]' | \
    jq -r 'reverse | .[]' | \
    while IFS= read -r line; do
        local date=$(echo "$line" | jq -r '.date')
        local count=$(echo "$line" | jq -r '.count')

        printf "%-12s [%2d] " "$date" "$count"

        # Simple bar
        for i in $(seq 1 $count); do printf "${GREEN}●${NC}"; done
        echo ""
    done

    echo ""
}

# Organization pie chart (ASCII)
graph_orgs() {
    echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║           ORGANIZATION DISTRIBUTION                                ║${NC}"
    echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local total=$(echo "$repos" | jq 'length')

    local orgs=("BlackRoad-OS" "BlackRoad-AI" "BlackRoad-Cloud" "BlackRoad-Labs" "BlackRoad-Foundation")

    for org in "${orgs[@]}"; do
        local count=$(gh repo list "$org" --limit 1000 --json name 2>/dev/null | jq 'length')
        local pct=$(echo "scale=1; $count * 100 / $total" | bc)

        printf "%-25s [%3d] " "$org" "$count"
        bar_graph "$count" "$total"
        printf " %.1f%%\n" "$pct"
    done

    echo ""
}

# Complexity distribution
graph_complexity() {
    echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║           PROJECT COMPLEXITY DISTRIBUTION                          ║${NC}"
    echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")

    # By description length (proxy for complexity)
    echo -e "${YELLOW}Based on description detail:${NC}"
    echo ""

    local simple=$(echo "$repos" | jq -r '[.[] | select(.description == null or ((.description | length) < 50))] | length')
    local moderate=$(echo "$repos" | jq -r '[.[] | select(.description != null and ((.description | length) >= 50) and ((.description | length) < 150))] | length')
    local complex=$(echo "$repos" | jq -r '[.[] | select(.description != null and ((.description | length) >= 150))] | length')

    printf "Simple       [%3d] " "$simple"
    bar_graph "$simple" "$(echo "$repos" | jq 'length')"
    echo ""

    printf "Moderate     [%3d] " "$moderate"
    bar_graph "$moderate" "$(echo "$repos" | jq 'length')"
    echo ""

    printf "Complex      [%3d] " "$complex"
    bar_graph "$complex" "$(echo "$repos" | jq 'length')"
    echo ""

    echo ""
}

# Category distribution
graph_categories() {
    echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║           CATEGORY DISTRIBUTION                                    ║${NC}"
    echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local total=$(echo "$repos" | jq 'length')

    declare -A categories
    categories["agent"]=$(echo "$repos" | jq -r '[.[] | select(.name | contains("agent"))] | length')
    categories["bot"]=$(echo "$repos" | jq -r '[.[] | select(.name | contains("bot"))] | length')
    categories["dashboard"]=$(echo "$repos" | jq -r '[.[] | select(.name | contains("dashboard"))] | length')
    categories["infra"]=$(echo "$repos" | jq -r '[.[] | select(.name | contains("infra"))] | length')
    categories["deploy"]=$(echo "$repos" | jq -r '[.[] | select(.name | contains("deploy"))] | length')
    categories["cloud"]=$(echo "$repos" | jq -r '[.[] | select(.name | contains("cloud"))] | length')
    categories["pack"]=$(echo "$repos" | jq -r '[.[] | select(.name | contains("pack"))] | length')

    for cat in "${!categories[@]}"; do
        local count=${categories[$cat]}
        if [ $count -gt 0 ]; then
            printf "%-15s [%3d] " "$cat" "$count"
            bar_graph "$count" "$total"
            echo ""
        fi
    done

    echo ""
}

# Update frequency heatmap
graph_frequency() {
    echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║           UPDATE FREQUENCY HEATMAP                                 ║${NC}"
    echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")

    # Define time buckets
    local today=$(date -u "+%Y-%m-%dT%H:%M:%SZ")
    local week_ago=$(date -u -v-7d "+%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -d '7 days ago' "+%Y-%m-%dT%H:%M:%SZ")
    local month_ago=$(date -u -v-30d "+%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -d '30 days ago' "+%Y-%m-%dT%H:%M:%SZ")
    local year_ago=$(date -u -v-365d "+%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -d '365 days ago' "+%Y-%m-%dT%H:%M:%SZ")

    local last_week=$(echo "$repos" | jq -r --arg cutoff "$week_ago" '[.[] | select(.pushedAt > $cutoff)] | length')
    local last_month=$(echo "$repos" | jq -r --arg cutoff "$month_ago" --arg week "$week_ago" '[.[] | select(.pushedAt > $cutoff and .pushedAt <= $week)] | length')
    local last_year=$(echo "$repos" | jq -r --arg cutoff "$year_ago" --arg month "$month_ago" '[.[] | select(.pushedAt > $cutoff and .pushedAt <= $month)] | length')
    local older=$(echo "$repos" | jq -r --arg cutoff "$year_ago" '[.[] | select(.pushedAt < $cutoff)] | length')

    printf "Last 7 days  [%3d] " "$last_week"
    bar_graph "$last_week" "$(echo "$repos" | jq 'length')"
    printf " ${GREEN}◆ Active${NC}\n"

    printf "Last 30 days [%3d] " "$last_month"
    bar_graph "$last_month" "$(echo "$repos" | jq 'length')"
    printf " ${YELLOW}◆ Recent${NC}\n"

    printf "Last year    [%3d] " "$last_year"
    bar_graph "$last_year" "$(echo "$repos" | jq 'length')"
    printf " ${BLUE}◆ Moderate${NC}\n"

    printf "Older        [%3d] " "$older"
    bar_graph "$older" "$(echo "$repos" | jq 'length')"
    printf " ${RED}◆ Dormant${NC}\n"

    echo ""
}

# Main
main() {
    if [ ! -f "$CACHE_FILE" ]; then
        echo -e "${RED}Error: Cache not found. Run 'bros refresh' first.${NC}"
        exit 1
    fi

    case "${1:-all}" in
        languages|lang)
            graph_languages
            ;;
        activity)
            graph_activity
            ;;
        orgs)
            graph_orgs
            ;;
        complexity)
            graph_complexity
            ;;
        categories|cat)
            graph_categories
            ;;
        frequency|freq)
            graph_frequency
            ;;
        all)
            graph_languages
            graph_orgs
            graph_categories
            graph_complexity
            graph_frequency
            graph_activity
            ;;
        *)
            echo "Usage: bros-graph [languages|activity|orgs|complexity|categories|frequency|all]"
            exit 1
            ;;
    esac
}

main "$@"
