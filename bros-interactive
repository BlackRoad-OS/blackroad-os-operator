#!/bin/bash
# Interactive TUI for bros - Full-screen repo explorer

VERSION="2.0.0"
CACHE_DIR="$HOME/.blackroad-cache"
CACHE_FILE="$CACHE_DIR/repos.json"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
MAGENTA='\033[0;35m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

# Fetch repos
fetch_repos() {
    if [ -f "$CACHE_FILE" ]; then
        cat "$CACHE_FILE"
    else
        ~/blackroad-os-operator/bros refresh >/dev/null 2>&1
        cat "$CACHE_FILE"
    fi
}

# Clear screen and show header
show_header() {
    clear
    echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║        BLACKROAD OS OPERATOR - Interactive Explorer v2.0          ║${NC}"
    echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# Main menu
main_menu() {
    show_header

    local repos=$(fetch_repos)
    local total=$(echo "$repos" | jq 'length')

    echo -e "${GREEN}Total repositories: ${BOLD}$total${NC} across 5 organizations"
    echo ""
    echo -e "${YELLOW}What would you like to do?${NC}"
    echo ""
    echo -e "  ${BLUE}1${NC}) Browse by ${CYAN}Language${NC}"
    echo -e "  ${BLUE}2${NC}) Browse by ${CYAN}Category${NC} (agent, bot, infra, etc)"
    echo -e "  ${BLUE}3${NC}) View ${CYAN}Recent Activity${NC}"
    echo -e "  ${BLUE}4${NC}) ${CYAN}Search${NC} for repos"
    echo -e "  ${BLUE}5${NC}) View ${CYAN}Organization Tree${NC}"
    echo -e "  ${BLUE}6${NC}) ${CYAN}Statistics${NC} & Overview"
    echo -e "  ${BLUE}7${NC}) ${CYAN}Clone${NC} repos"
    echo -e "  ${BLUE}r${NC}) ${YELLOW}Refresh${NC} cache"
    echo -e "  ${BLUE}q${NC}) ${RED}Quit${NC}"
    echo ""
    echo -ne "${GREEN}${BOLD}Choose:${NC} "
    read -r choice

    case "$choice" in
        1) browse_languages ;;
        2) browse_categories ;;
        3) view_recent ;;
        4) search_interactive ;;
        5) view_tree ;;
        6) view_stats ;;
        7) clone_interactive ;;
        r) refresh_cache ;;
        q) exit 0 ;;
        *) main_menu ;;
    esac
}

# Browse by language
browse_languages() {
    show_header
    echo -e "${CYAN}${BOLD}Available Languages:${NC}"
    echo ""

    local repos=$(fetch_repos)
    local langs=$(echo "$repos" | jq -r '[.[] | .primaryLanguage.name // "Unknown"] | unique | sort | .[]')

    local i=1
    echo "$langs" | while read -r lang; do
        local count=$(echo "$repos" | jq -r --arg lang "$lang" '[.[] | select((.primaryLanguage.name // "Unknown") == $lang)] | length')
        printf "  ${BLUE}%2d${NC}) ${GREEN}%-15s${NC} (${YELLOW}%d repos${NC})\n" $i "$lang" $count
        i=$((i + 1))
    done

    echo ""
    echo -ne "${GREEN}Select language (number) or [b]ack:${NC} "
    read -r choice

    if [[ "$choice" = "b" ]]; then
        main_menu
        return
    fi

    local selected_lang=$(echo "$langs" | sed -n "${choice}p")

    if [ -n "$selected_lang" ]; then
        ~/blackroad-os-operator/bros lang "$selected_lang"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read
    fi

    browse_languages
}

# Browse by category
browse_categories() {
    show_header
    echo -e "${CYAN}${BOLD}Browse by Category:${NC}"
    echo ""
    echo -e "  ${BLUE}1${NC}) ${GREEN}agent${NC} - Agent & AI systems"
    echo -e "  ${BLUE}2${NC}) ${GREEN}bot${NC} - Bots & automation"
    echo -e "  ${BLUE}3${NC}) ${GREEN}infra${NC} - Infrastructure"
    echo -e "  ${BLUE}4${NC}) ${GREEN}deploy${NC} - Deployment tools"
    echo -e "  ${BLUE}5${NC}) ${GREEN}dashboard${NC} - Dashboards & UIs"
    echo -e "  ${BLUE}6${NC}) ${GREEN}cloud${NC} - Cloud services"
    echo -e "  ${BLUE}7${NC}) ${GREEN}pack${NC} - Packaged solutions"
    echo -e "  ${BLUE}8${NC}) ${CYAN}Custom search${NC}"
    echo -e "  ${BLUE}b${NC}) Back"
    echo ""
    echo -ne "${GREEN}Choose:${NC} "
    read -r choice

    local category=""
    case "$choice" in
        1) category="agent" ;;
        2) category="bot" ;;
        3) category="infra" ;;
        4) category="deploy" ;;
        5) category="dashboard" ;;
        6) category="cloud" ;;
        7) category="pack" ;;
        8)
            echo -ne "${GREEN}Enter category:${NC} "
            read -r category
            ;;
        b) main_menu; return ;;
        *) browse_categories; return ;;
    esac

    if [ -n "$category" ]; then
        ~/blackroad-os-operator/bros category "$category"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read
    fi

    browse_categories
}

# View recent activity
view_recent() {
    show_header
    echo -ne "${GREEN}How many recent repos to show (default 10):${NC} "
    read -r count
    count=${count:-10}

    ~/blackroad-os-operator/bros recent "$count"

    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read
    main_menu
}

# Interactive search
search_interactive() {
    show_header
    echo -ne "${GREEN}Search for:${NC} "
    read -r query

    if [ -n "$query" ]; then
        ~/blackroad-os-operator/bros search "$query"
        echo ""
        echo -ne "${YELLOW}Press Enter to continue...${NC}"
        read
    fi

    main_menu
}

# View tree
view_tree() {
    ~/blackroad-os-operator/bros tree
    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read
    main_menu
}

# View stats
view_stats() {
    ~/blackroad-os-operator/bros stats
    echo ""
    echo -ne "${YELLOW}Press Enter to continue...${NC}"
    read
    main_menu
}

# Clone repos interactively
clone_interactive() {
    show_header
    echo -e "${CYAN}${BOLD}Clone Repositories:${NC}"
    echo ""
    echo -e "  ${BLUE}1${NC}) Clone single repo (by name)"
    echo -e "  ${BLUE}2${NC}) Clone multiple repos (by pattern)"
    echo -e "  ${BLUE}b${NC}) Back"
    echo ""
    echo -ne "${GREEN}Choose:${NC} "
    read -r choice

    case "$choice" in
        1)
            echo -ne "${GREEN}Repo name (partial match):${NC} "
            read -r name
            if [ -n "$name" ]; then
                ~/blackroad-os-operator/bros clone "$name"
                echo ""
                echo -ne "${YELLOW}Press Enter to continue...${NC}"
                read
            fi
            clone_interactive
            ;;
        2)
            echo -ne "${GREEN}Pattern (e.g., agent, dashboard):${NC} "
            read -r pattern
            if [ -n "$pattern" ]; then
                ~/blackroad-os-operator/bros clone-all "$pattern"
                echo ""
                echo -ne "${YELLOW}Press Enter to continue...${NC}"
                read
            fi
            clone_interactive
            ;;
        b)
            main_menu
            ;;
        *)
            clone_interactive
            ;;
    esac
}

# Refresh cache
refresh_cache() {
    show_header
    echo -e "${YELLOW}Refreshing repository cache...${NC}"
    ~/blackroad-os-operator/bros refresh
    echo ""
    echo -ne "${GREEN}Cache refreshed! Press Enter to continue...${NC}"
    read
    main_menu
}

# Start
main_menu
