#!/bin/bash
# Sync tool - keep local repos in sync with remote

CACHE_FILE="$HOME/.blackroad-cache/repos.json"
LOCAL_DIR="${BLACKROAD_LOCAL_DIR:-$HOME/blackroad-repos}"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
MAGENTA='\033[0;35m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

show_header() {
    echo -e "${CYAN}${BOLD}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}${BOLD}‚ïë          BLACKROAD REPOSITORY SYNC ENGINE                          ‚ïë${NC}"
    echo -e "${CYAN}${BOLD}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

# Check sync status
sync_status() {
    show_header
    echo -e "${GREEN}üìä Sync Status${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    local total=$(echo "$repos" | jq 'length')
    local local_count=0
    local synced=0
    local behind=0
    local ahead=0

    mkdir -p "$LOCAL_DIR"

    echo -e "${CYAN}Local directory: $LOCAL_DIR${NC}"
    echo -e "${CYAN}Remote repos: $total${NC}"
    echo ""

    echo "$repos" | jq -r '.[] | .name' | while read -r name; do
        if [ -d "$LOCAL_DIR/$name" ]; then
            ((local_count++))

            cd "$LOCAL_DIR/$name"
            git fetch origin -q 2>/dev/null

            local status=$(git rev-list --left-right --count origin/main...HEAD 2>/dev/null || git rev-list --left-right --count origin/master...HEAD 2>/dev/null || echo "0	0")
            local remote_ahead=$(echo "$status" | cut -f1)
            local local_ahead=$(echo "$status" | cut -f2)

            if [ "$remote_ahead" = "0" ] && [ "$local_ahead" = "0" ]; then
                echo -e "  ${GREEN}‚úì $name${NC} - in sync"
                ((synced++))
            elif [ "$remote_ahead" != "0" ]; then
                echo -e "  ${YELLOW}‚Üì $name${NC} - $remote_ahead commits behind"
                ((behind++))
            elif [ "$local_ahead" != "0" ]; then
                echo -e "  ${BLUE}‚Üë $name${NC} - $local_ahead commits ahead"
                ((ahead++))
            fi
        fi
    done

    echo ""
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${GREEN}Summary:${NC}"
    echo -e "  Total remote repos: $total"
    echo -e "  Cloned locally: $local_count"
    echo -e "  ${GREEN}In sync: $synced${NC}"
    echo -e "  ${YELLOW}Behind remote: $behind${NC}"
    echo -e "  ${BLUE}Ahead of remote: $ahead${NC}"
    echo ""
}

# Pull all repos
sync_pull() {
    show_header
    echo -e "${GREEN}‚¨áÔ∏è  Pulling All Repositories${NC}"
    echo ""

    mkdir -p "$LOCAL_DIR"
    cd "$LOCAL_DIR"

    local updated=0
    local failed=0

    for dir in */; do
        if [ -d "$dir/.git" ]; then
            cd "$dir"
            local name=$(basename "$dir")

            echo -e "${CYAN}Pulling: $name${NC}"

            if git pull origin main 2>/dev/null || git pull origin master 2>/dev/null; then
                echo -e "  ${GREEN}‚úì Updated${NC}"
                ((updated++))
            else
                echo -e "  ${RED}‚úó Failed${NC}"
                ((failed++))
            fi

            cd ..
        fi
    done

    echo ""
    echo -e "${GREEN}‚úì Pull complete: $updated updated, $failed failed${NC}"
}

# Clone missing repos
sync_clone() {
    show_header
    echo -e "${GREEN}üì• Cloning Missing Repositories${NC}"
    echo ""

    local repos=$(cat "$CACHE_FILE")
    mkdir -p "$LOCAL_DIR"
    cd "$LOCAL_DIR"

    local cloned=0

    echo "$repos" | jq -r '.[] | "\(.name)|\(.url)"' | while IFS='|' read -r name url; do
        if [ ! -d "$name" ]; then
            echo -e "${CYAN}Cloning: $name${NC}"
            if gh repo clone "$url" 2>&1 | grep -v "already exists"; then
                echo -e "  ${GREEN}‚úì Cloned${NC}"
                ((cloned++))
            fi
        fi
    done

    echo ""
    echo -e "${GREEN}‚úì Clone complete: $cloned new repos${NC}"
}

# Sync all (clone + pull)
sync_all() {
    sync_clone
    echo ""
    sync_pull
}

# Push all repos with changes
sync_push() {
    show_header
    echo -e "${GREEN}‚¨ÜÔ∏è  Pushing All Changed Repositories${NC}"
    echo ""

    mkdir -p "$LOCAL_DIR"
    cd "$LOCAL_DIR"

    local pushed=0

    for dir in */; do
        if [ -d "$dir/.git" ]; then
            cd "$dir"
            local name=$(basename "$dir")

            # Check if there are uncommitted changes or unpushed commits
            if ! git diff-index --quiet HEAD -- 2>/dev/null || [ -n "$(git log origin/main..HEAD 2>/dev/null || git log origin/master..HEAD 2>/dev/null)" ]; then
                echo -e "${CYAN}Pushing: $name${NC}"

                # Commit changes if any
                if ! git diff-index --quiet HEAD -- 2>/dev/null; then
                    git add -A
                    git commit -m "Auto-sync: $(date '+%Y-%m-%d %H:%M:%S')"
                fi

                # Push
                if git push 2>&1; then
                    echo -e "  ${GREEN}‚úì Pushed${NC}"
                    ((pushed++))
                else
                    echo -e "  ${RED}‚úó Failed${NC}"
                fi
            fi

            cd ..
        fi
    done

    echo ""
    echo -e "${GREEN}‚úì Push complete: $pushed repos pushed${NC}"
}

# Watch mode - continuous sync
sync_watch() {
    show_header
    echo -e "${GREEN}üëÅÔ∏è  Watch Mode - Syncing every 5 minutes${NC}"
    echo -e "${YELLOW}Press Ctrl+C to stop${NC}"
    echo ""

    while true; do
        sync_pull
        echo ""
        echo -e "${BLUE}Next sync in 5 minutes...${NC}"
        sleep 300
    done
}

# Main
main() {
    case "${1:-help}" in
        status)
            sync_status
            ;;
        pull)
            sync_pull
            ;;
        clone)
            sync_clone
            ;;
        push)
            sync_push
            ;;
        all)
            sync_all
            ;;
        watch)
            sync_watch
            ;;
        *)
            echo "Usage: bros-sync <command>"
            echo ""
            echo "Commands:"
            echo "  status    Check sync status of all repos"
            echo "  pull      Pull latest changes for all repos"
            echo "  clone     Clone any missing repos"
            echo "  push      Push all repos with changes"
            echo "  all       Clone missing + pull all"
            echo "  watch     Continuous sync mode (every 5 min)"
            echo ""
            echo "Local directory: $LOCAL_DIR"
            echo "(Set BLACKROAD_LOCAL_DIR to change)"
            ;;
    esac
}

main "$@"
