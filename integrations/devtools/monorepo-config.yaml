# Monorepo Integration Configuration
# BlackRoad OS Multi-Repository Architecture
#
# Defines how all 24 repositories work together as a cohesive system
#
# @blackroad_name: BlackRoad Monorepo
# @operator: alexa.operator.v1

version: "monorepo-v1"

# ============================================
# TURBOREPO CONFIGURATION (for blackroad-os)
# ============================================

turborepo:
  # Root turbo.json configuration
  pipeline:
    build:
      dependsOn: ["^build"]
      outputs: ["dist/**", ".next/**", "out/**"]
      cache: true

    test:
      dependsOn: ["build"]
      outputs: ["coverage/**"]
      cache: true

    lint:
      outputs: []
      cache: true

    typecheck:
      dependsOn: ["^build"]
      outputs: []
      cache: true

    dev:
      cache: false
      persistent: true

    deploy:
      dependsOn: ["build", "test"]
      cache: false

  # Remote caching
  remote_cache:
    enabled: true
    team: blackroad
    signature: true

# ============================================
# PACKAGE STRUCTURE
# ============================================

packages:
  # Internal packages (shared across repos)
  internal:
    - name: "@blackroad/config-eslint"
      path: tooling/eslint-config
      description: "Shared ESLint configuration"

    - name: "@blackroad/config-typescript"
      path: tooling/typescript-config
      description: "Shared TypeScript configuration"

    - name: "@blackroad/config-tailwind"
      path: tooling/tailwind-config
      description: "Shared Tailwind CSS configuration"

    - name: "@blackroad/ui"
      path: packages/ui
      description: "Shared UI component library"

    - name: "@blackroad/database"
      path: packages/database
      description: "Prisma database client"

    - name: "@blackroad/auth"
      path: packages/auth
      description: "Authentication utilities"

  # Published packages
  published:
    - name: "@blackroad/core"
      source: blackroad-os-core
      path: packages/core
      registry: npm

    - name: "@blackroad/utils"
      source: blackroad-os-core
      path: packages/utils
      registry: npm

    - name: "@blackroad/types"
      source: blackroad-os-core
      path: packages/types
      registry: npm

    - name: "@blackroad/api-client"
      source: blackroad-os-api
      path: packages/client
      registry: npm

    - name: blackroad-core
      source: blackroad-os-core
      path: python/blackroad_core
      registry: pypi

    - name: blackroad-api
      source: blackroad-os-api
      path: python/blackroad_api
      registry: pypi

    - name: br-operator
      source: blackroad-os-operator
      path: .
      registry: pypi

# ============================================
# DEPENDENCY GRAPH
# ============================================

dependency_graph:
  # Core dependencies (foundation layer)
  tier_0:
    repos:
      - blackroad-os-core
      - blackroad-os-master
    description: "Foundation packages and configurations"
    dependencies: []

  # API layer
  tier_1:
    repos:
      - blackroad-os-operator
      - blackroad-os-api-gateway
      - blackroad-os-api
    description: "API services and SDKs"
    dependencies:
      - blackroad-os-core

  # Agent layer
  tier_2:
    repos:
      - blackroad-os-agents
      - blackroad-os-beacon
    description: "AI agents and model routing"
    dependencies:
      - blackroad-os-core
      - blackroad-os-operator

  # Web layer
  tier_3:
    repos:
      - blackroad-os-web
      - blackroad-os-prism-console
      - blackroad-os-demo
      - blackroad-os-home
    description: "Web applications and frontends"
    dependencies:
      - blackroad-os-core
      - blackroad-os-api

  # Pack layer
  tier_4:
    repos:
      - blackroad-os-pack-research-lab
      - blackroad-os-pack-finance
      - blackroad-os-pack-education
      - blackroad-os-pack-creator-studio
      - blackroad-os-pack-legal
      - blackroad-os-pack-infra-devops
    description: "Vertical solution packs"
    dependencies:
      - blackroad-os-core
      - blackroad-os-agents

  # Documentation layer
  tier_5:
    repos:
      - blackroad-os-docs
      - blackroad-os-research
      - blackroad-os-ideas
    description: "Documentation and research"
    dependencies: []

  # Infrastructure layer
  tier_infra:
    repos:
      - blackroad-os-infra
    description: "Infrastructure as Code"
    dependencies: []

  # Support repos
  tier_support:
    repos:
      - blackroad-os-brand
      - blackroad-os-archive
    description: "Assets and archive"
    dependencies: []

# ============================================
# CROSS-REPOSITORY WORKFLOWS
# ============================================

cross_repo_workflows:
  # Sync core package updates
  sync-core:
    trigger:
      repo: blackroad-os-core
      event: release
    actions:
      - repos:
          - blackroad-os-operator
          - blackroad-os-api-gateway
          - blackroad-os-api
          - blackroad-os-agents
          - blackroad-os-beacon
          - blackroad-os-web
        action: create_pr
        title: "chore(deps): update @blackroad/core to {{version}}"
        body: |
          This PR updates @blackroad/core to version {{version}}.

          ## Changes
          {{changelog}}

          Auto-generated by BlackRoad monorepo sync.

  # Sync API schema updates
  sync-api-schema:
    trigger:
      repo: blackroad-os-master
      event: push
      paths:
        - "schemas/**"
    actions:
      - repos:
          - blackroad-os-operator
          - blackroad-os-api-gateway
          - blackroad-os-web
          - blackroad-os-prism-console
        action: create_pr
        title: "chore(schemas): sync API schemas"

  # Sync TypeScript types
  sync-types:
    trigger:
      repo: blackroad-os-core
      event: push
      paths:
        - "packages/types/**"
    actions:
      - repos:
          - blackroad-os-web
          - blackroad-os-prism-console
          - blackroad-os-demo
        action: create_pr
        title: "chore(types): sync @blackroad/types"

  # Coordinated release
  coordinated-release:
    trigger: workflow_dispatch
    params:
      - name: version
        type: string
        required: true
    steps:
      - name: Bump versions
        repos:
          - blackroad-os-core
          - blackroad-os-api
          - blackroad-os-operator
        action: bump_version
        version: "{{version}}"

      - name: Create release PRs
        repos:
          - blackroad-os-core
          - blackroad-os-api
          - blackroad-os-operator
        action: create_release_pr

      - name: Run integration tests
        action: run_workflow
        workflow: integration-tests.yaml

      - name: Merge and tag
        action: merge_and_tag
        tag: "v{{version}}"

# ============================================
# SHARED TOOLING
# ============================================

shared_tooling:
  # Linting
  eslint:
    extends: "@blackroad/eslint-config"
    source: blackroad-os-core/tooling/eslint-config

  # TypeScript
  typescript:
    extends: "@blackroad/typescript-config"
    source: blackroad-os-core/tooling/typescript-config

  # Prettier
  prettier:
    config:
      semi: false
      singleQuote: true
      tabWidth: 2
      trailingComma: "es5"
      printWidth: 100

  # Commitlint
  commitlint:
    extends: "@commitlint/config-conventional"
    rules:
      scope-enum:
        - 2
        - always
        - [
            "core",
            "api",
            "web",
            "agents",
            "beacon",
            "console",
            "docs",
            "infra",
            "deps",
            "ci",
          ]

  # Husky hooks
  husky:
    pre-commit:
      - lint-staged
    commit-msg:
      - commitlint --edit $1
    pre-push:
      - pnpm typecheck

  # Lint-staged
  lint_staged:
    "*.{ts,tsx}":
      - eslint --fix
      - prettier --write
    "*.{json,md,yaml,yml}":
      - prettier --write
    "*.py":
      - ruff check --fix
      - ruff format

# ============================================
# VERSIONING STRATEGY
# ============================================

versioning:
  # Semantic versioning with conventional commits
  strategy: conventional-commits

  # Packages that version together
  version_groups:
    core:
      packages:
        - "@blackroad/core"
        - "@blackroad/utils"
        - "@blackroad/types"
        - "blackroad-core"
      strategy: fixed

    api:
      packages:
        - "@blackroad/api-client"
        - "blackroad-api"
      strategy: fixed

  # Independent versions
  independent:
    - br-operator
    - blackroad-os-web
    - blackroad-os-agents

  # Changelog generation
  changelog:
    generator: git-cliff
    config:
      header: "# Changelog\n\nAll notable changes to this project will be documented in this file.\n"
      body: |
        {% for group, commits in commits | group_by(attribute="group") %}
        ### {{ group | striptags | trim | upper_first }}
        {% for commit in commits %}
        - {% if commit.scope %}**{{ commit.scope }}:** {% endif %}{{ commit.message | upper_first }}\
        {% endfor %}
        {% endfor %}

# ============================================
# DEVELOPMENT WORKFLOW
# ============================================

development:
  # Local development setup
  setup:
    steps:
      - name: Clone repositories
        script: |
          gh repo clone BlackRoad-OS/blackroad-os-core
          gh repo clone BlackRoad-OS/blackroad-os-operator
          # ... other repos as needed

      - name: Install dependencies
        script: |
          pnpm install
          pip install -e ".[dev]"

      - name: Start services
        script: |
          docker-compose up -d
          pnpm dev

  # Docker compose for local development
  docker_compose:
    services:
      postgres:
        image: postgres:15
        ports:
          - "5432:5432"
        environment:
          POSTGRES_USER: blackroad
          POSTGRES_PASSWORD: blackroad
          POSTGRES_DB: blackroad

      redis:
        image: redis:7
        ports:
          - "6379:6379"

      pinecone:
        image: pinecone-local
        ports:
          - "5080:5080"

  # Environment variables
  env_template:
    # Database
    DATABASE_URL: "postgresql://blackroad:blackroad@localhost:5432/blackroad"
    REDIS_URL: "redis://localhost:6379"

    # APIs (get from .env.local or 1Password)
    ANTHROPIC_API_KEY: ""
    OPENAI_API_KEY: ""
    PINECONE_API_KEY: ""

    # Auth
    AUTH0_DOMAIN: ""
    AUTH0_CLIENT_ID: ""
    AUTH0_CLIENT_SECRET: ""

# ============================================
# INTEGRATION TESTS
# ============================================

integration_tests:
  # Cross-repo integration test suite
  suites:
    api-web:
      repos:
        - blackroad-os-operator
        - blackroad-os-web
      tests:
        - auth_flow
        - agent_creation
        - policy_enforcement

    api-agents:
      repos:
        - blackroad-os-operator
        - blackroad-os-agents
        - blackroad-os-beacon
      tests:
        - agent_invocation
        - memory_persistence
        - llm_routing

    full-stack:
      repos:
        - blackroad-os-operator
        - blackroad-os-web
        - blackroad-os-agents
        - blackroad-os-beacon
      tests:
        - end_to_end_flow
        - governance_chain
        - intent_execution

  # Test environments
  environments:
    ci:
      runner: github-actions
      timeout: 30m

    staging:
      url: https://staging.api.blackroad.io
      timeout: 15m

# ============================================
# RELEASE CHECKLIST
# ============================================

release_checklist:
  pre_release:
    - All tests passing
    - Changelog updated
    - Version bumped
    - Documentation updated
    - Migration scripts ready

  release:
    - Create GitHub release
    - Publish npm packages
    - Publish PyPI packages
    - Deploy to Railway
    - Deploy to Cloudflare Pages

  post_release:
    - Update documentation site
    - Notify Slack #releases
    - Update status page
    - Monitor error rates
    - Verify health checks
