# BlackRoad OS - Event Bus at Scale
# Trillion-Event Streaming Infrastructure
#
# @blackroad_name Event Bus Scale
# @operator alexa.operator.v1
# @priority P0 (Critical)

version: "1.0"
system: event-bus-scale
namespace: blackroad.streaming

# =============================================================================
# ARCHITECTURE OVERVIEW
# =============================================================================
#
# Event Bus at Scale enables:
# - 10M+ events/second global throughput
# - Sub-10ms event delivery latency (same region)
# - Exactly-once delivery semantics
# - Multi-region replication with geo-awareness
# - Event sourcing for complete audit trails
# - Real-time stream processing for governance
# - Integration with Agent Mesh Protocol for event-driven agents

# =============================================================================
# EVENT SCHEMA
# =============================================================================

event_schema:
  # Base event envelope
  envelope:
    event_id:
      type: string
      format: ulid
      description: "Globally unique event identifier"
      required: true

    event_type:
      type: string
      format: event-type-urn
      example: "urn:blackroad:event:agent:invoked:v1"
      required: true

    version:
      type: string
      pattern: "^\\d+$"
      description: "Schema version for this event type"
      required: true

    timestamp_us:
      type: integer
      format: int64
      description: "Event timestamp in microseconds"
      required: true

    # Source identification
    source:
      agent_id:
        type: string
        format: agent-urn
      service_id:
        type: string
      node_id:
        type: string
      region:
        type: string
      required: true

    # Correlation
    correlation:
      intent_id:
        type: string
        format: ulid
        description: "Originating intent"
      session_id:
        type: string
      trace_id:
        type: string
        format: trace-id
      parent_event_id:
        type: string
        format: ulid

    # Trinary state
    trinary:
      state:
        type: integer
        enum: [-1, 0, 1]
      policy_id:
        type: string

    # Payload
    payload:
      content_type:
        type: string
        enum:
          - application/json
          - application/msgpack
          - application/protobuf
        default: application/json
      schema_ref:
        type: string
        description: "Schema registry reference"
      data:
        type: object
      size_bytes:
        type: integer
        maximum: 1048576  # 1MB max

    # Metadata
    metadata:
      partition_key:
        type: string
        description: "Key for partitioning"
      priority:
        type: integer
        minimum: 0
        maximum: 10
        default: 5
      ttl_seconds:
        type: integer
      idempotency_key:
        type: string

  # Event type catalog
  event_types:
    # Agent events
    agents:
      - type: "agent:registered"
        description: "New agent registered in mesh"
      - type: "agent:invoked"
        description: "Agent invocation started"
      - type: "agent:completed"
        description: "Agent invocation completed"
      - type: "agent:failed"
        description: "Agent invocation failed"
      - type: "agent:delegated"
        description: "Task delegated to another agent"
      - type: "agent:capability_changed"
        description: "Agent capabilities updated"

    # Governance events
    governance:
      - type: "policy:evaluated"
        description: "Policy evaluation completed"
      - type: "policy:updated"
        description: "Policy definition changed"
      - type: "trinary:decision"
        description: "Trinary decision made"
      - type: "escalation:triggered"
        description: "Human escalation required"
      - type: "contradiction:detected"
        description: "Policy contradiction found"

    # Ledger events
    ledger:
      - type: "ledger:entry_created"
        description: "New ledger entry recorded"
      - type: "ledger:lineage_updated"
        description: "Lineage chain extended"
      - type: "ledger:audit_requested"
        description: "Audit trail requested"

    # Mesh events
    mesh:
      - type: "mesh:node_joined"
        description: "Node joined the mesh"
      - type: "mesh:node_left"
        description: "Node left the mesh"
      - type: "mesh:failover"
        description: "Failover event occurred"
      - type: "mesh:rebalance"
        description: "Partition rebalancing"

    # Memory events
    memory:
      - type: "memory:created"
        description: "New memory stored"
      - type: "memory:accessed"
        description: "Memory retrieved"
      - type: "memory:tier_changed"
        description: "Memory moved between tiers"
      - type: "memory:expired"
        description: "Memory TTL expired"

# =============================================================================
# KAFKA CLUSTER CONFIGURATION
# =============================================================================

kafka:
  # Global cluster topology
  clusters:
    # Primary clusters (one per major region)
    primary:
      us_west:
        region: us-west-2
        brokers: 30
        partitions_default: 256
        replication_factor: 3
        rack_awareness: true

      us_east:
        region: us-east-1
        brokers: 30
        partitions_default: 256
        replication_factor: 3
        rack_awareness: true

      eu_west:
        region: eu-west-1
        brokers: 20
        partitions_default: 256
        replication_factor: 3
        rack_awareness: true

      ap_northeast:
        region: ap-northeast-1
        brokers: 20
        partitions_default: 256
        replication_factor: 3
        rack_awareness: true

    # Cross-region replication
    mirror_maker:
      enabled: true
      version: "2.0"
      sync_mode: async
      sync_interval_ms: 100

      topology:
        - source: us_west
          target: us_east
          topics: ["*"]
        - source: us_east
          target: eu_west
          topics: ["governance.*", "ledger.*"]
        - source: eu_west
          target: ap_northeast
          topics: ["governance.*", "ledger.*"]

  # Broker configuration
  broker_config:
    # Performance tuning
    num_network_threads: 8
    num_io_threads: 16
    socket_send_buffer_bytes: 1048576
    socket_receive_buffer_bytes: 1048576
    socket_request_max_bytes: 104857600

    # Log configuration
    log_segment_bytes: 1073741824  # 1GB
    log_retention_hours: 168  # 7 days
    log_retention_bytes: -1  # Unlimited
    log_cleanup_policy: delete

    # Replication
    min_insync_replicas: 2
    unclean_leader_election_enable: false
    auto_leader_rebalance_enable: true

    # Compression
    compression_type: lz4

  # Topic configuration
  topics:
    # High-volume agent events
    agent_events:
      name: "blackroad.agents.events"
      partitions: 1024
      replication_factor: 3
      retention_ms: 604800000  # 7 days
      retention_bytes: 10995116277760  # 10TB
      cleanup_policy: delete
      compression_type: lz4

    # Governance events (longer retention)
    governance_events:
      name: "blackroad.governance.events"
      partitions: 256
      replication_factor: 3
      retention_ms: 2592000000  # 30 days
      cleanup_policy: compact
      compression_type: zstd

    # Ledger events (permanent)
    ledger_events:
      name: "blackroad.ledger.events"
      partitions: 256
      replication_factor: 3
      retention_ms: -1  # Infinite
      cleanup_policy: compact
      compression_type: zstd

    # Mesh coordination
    mesh_coordination:
      name: "blackroad.mesh.coordination"
      partitions: 64
      replication_factor: 3
      retention_ms: 86400000  # 1 day
      cleanup_policy: delete

    # Memory events
    memory_events:
      name: "blackroad.memory.events"
      partitions: 512
      replication_factor: 3
      retention_ms: 259200000  # 3 days
      cleanup_policy: delete

    # Dead letter queue
    dlq:
      name: "blackroad.dlq"
      partitions: 64
      replication_factor: 3
      retention_ms: 2592000000  # 30 days

# =============================================================================
# STREAM PROCESSING
# =============================================================================

stream_processing:
  # Flink cluster configuration
  flink:
    enabled: true

    cluster:
      job_managers: 3
      task_managers: 50
      task_slots_per_manager: 8
      parallelism_default: 200

    checkpointing:
      enabled: true
      interval_ms: 10000
      timeout_ms: 60000
      min_pause_ms: 500
      max_concurrent: 1
      mode: exactly_once
      storage: s3

    state_backend:
      type: rocksdb
      incremental: true
      storage: s3

  # Processing pipelines
  pipelines:
    # Real-time governance
    governance_pipeline:
      name: "governance-evaluator"
      source: "blackroad.agents.events"
      sink: "blackroad.governance.events"
      parallelism: 100

      operations:
        - type: filter
          condition: "event_type LIKE 'agent:%'"

        - type: enrich
          source: policy_service
          key: agent_id
          fields: [applicable_policies]

        - type: evaluate
          function: trinary_policy_evaluation
          output: trinary_decision

        - type: route
          conditions:
            - when: "trinary_decision.state = -1"
              to: "blackroad.governance.denials"
            - when: "trinary_decision.state = 0"
              to: "blackroad.governance.escalations"
            - when: "trinary_decision.state = 1"
              to: "blackroad.governance.approvals"

    # Audit trail builder
    audit_pipeline:
      name: "audit-trail-builder"
      source: "blackroad.governance.events"
      sink: "blackroad.ledger.events"
      parallelism: 50

      operations:
        - type: window
          type: session
          gap_ms: 60000
          key: intent_id

        - type: aggregate
          function: build_audit_trail
          output: ledger_entry

        - type: enrich
          function: compute_ps_sha_hash
          output: lineage_hash

    # Anomaly detection
    anomaly_pipeline:
      name: "anomaly-detector"
      source: "blackroad.agents.events"
      sink: "blackroad.alerts"
      parallelism: 30

      operations:
        - type: window
          type: tumbling
          size_ms: 60000

        - type: aggregate
          function: compute_statistics
          key: agent_id
          metrics: [invocation_count, error_rate, latency_p99]

        - type: detect
          function: statistical_anomaly
          threshold: 3.0  # Standard deviations
          output: anomaly_score

        - type: filter
          condition: "anomaly_score > 0.95"

# =============================================================================
# CONSUMER GROUPS
# =============================================================================

consumer_groups:
  # Configuration per group type
  types:
    # Real-time processors
    realtime:
      auto_offset_reset: latest
      enable_auto_commit: false
      max_poll_records: 500
      max_poll_interval_ms: 300000
      session_timeout_ms: 30000
      heartbeat_interval_ms: 3000

    # Batch processors
    batch:
      auto_offset_reset: earliest
      enable_auto_commit: false
      max_poll_records: 10000
      max_poll_interval_ms: 600000
      session_timeout_ms: 60000

    # Replay consumers
    replay:
      auto_offset_reset: earliest
      enable_auto_commit: false
      max_poll_records: 1000
      isolation_level: read_committed

  # Defined groups
  groups:
    # Agent event consumers
    agent_event_processors:
      type: realtime
      topics:
        - "blackroad.agents.events"
      instances: 100
      processing_guarantee: exactly_once

    # Governance evaluators
    governance_evaluators:
      type: realtime
      topics:
        - "blackroad.agents.events"
        - "blackroad.mesh.coordination"
      instances: 50
      processing_guarantee: exactly_once

    # Ledger writers
    ledger_writers:
      type: realtime
      topics:
        - "blackroad.governance.events"
      instances: 20
      processing_guarantee: exactly_once

    # Analytics consumers
    analytics_consumers:
      type: batch
      topics:
        - "blackroad.*"
      instances: 10
      processing_guarantee: at_least_once

# =============================================================================
# EXACTLY-ONCE SEMANTICS
# =============================================================================

exactly_once:
  # Transaction configuration
  transactions:
    enabled: true
    timeout_ms: 60000
    max_in_flight: 5

    # Producer settings
    producer:
      enable_idempotence: true
      acks: all
      retries: 2147483647
      max_in_flight_requests: 5
      transactional_id_prefix: "blackroad-producer"

    # Consumer settings
    consumer:
      isolation_level: read_committed
      enable_auto_commit: false

  # Idempotency
  idempotency:
    enabled: true

    deduplication:
      window_ms: 3600000  # 1 hour
      storage: redis
      key_format: "dedup:{idempotency_key}"

    strategies:
      - event_id_based
      - idempotency_key_based
      - content_hash_based

# =============================================================================
# SCHEMA REGISTRY
# =============================================================================

schema_registry:
  # Confluent Schema Registry
  provider: confluent

  clusters:
    primary:
      url: "https://schema.blackroad.io"
      instances: 3

    regional:
      - region: us-west-2
        url: "https://schema.us-west-2.blackroad.io"
      - region: eu-west-1
        url: "https://schema.eu-west-1.blackroad.io"

  configuration:
    compatibility_level: BACKWARD_TRANSITIVE
    schema_format: json_schema  # Also supports avro, protobuf
    normalize_schemas: true

  # Schema evolution rules
  evolution:
    allowed_changes:
      - add_optional_field
      - add_field_with_default
      - remove_optional_field
      - widen_type

    forbidden_changes:
      - remove_required_field
      - narrow_type
      - rename_field

  # Schema validation
  validation:
    enabled: true
    on_produce: true
    on_consume: true
    reject_invalid: true

# =============================================================================
# DELIVERY GUARANTEES
# =============================================================================

delivery:
  # Acknowledgment modes
  acknowledgment:
    producer:
      acks: all
      timeout_ms: 30000

    consumer:
      mode: manual
      commit_strategy: after_processing

  # Retry policies
  retry:
    producer:
      max_retries: 2147483647
      retry_backoff_ms: 100
      delivery_timeout_ms: 120000

    consumer:
      max_retries: 5
      retry_backoff_ms: 1000
      max_backoff_ms: 60000
      retry_topic: "blackroad.retry.{original_topic}"

  # Dead letter queue
  dlq:
    enabled: true
    topic: "blackroad.dlq"
    include_headers: true
    include_metadata:
      - original_topic
      - original_partition
      - failure_reason
      - retry_count
      - timestamp

  # Ordering guarantees
  ordering:
    partition_level: guaranteed
    global: best_effort

    ordering_keys:
      agent_events: agent_id
      governance_events: intent_id
      ledger_events: ledger_entry_id
      mesh_events: node_id

# =============================================================================
# BACKPRESSURE & FLOW CONTROL
# =============================================================================

backpressure:
  # Producer backpressure
  producer:
    buffer_memory_bytes: 67108864  # 64MB
    max_block_ms: 60000
    batch_size_bytes: 16384
    linger_ms: 5

    throttling:
      enabled: true
      rate_limit_per_partition: 10000
      burst_allowance: 2.0

  # Consumer backpressure
  consumer:
    fetch_max_bytes: 52428800  # 50MB
    max_partition_fetch_bytes: 1048576  # 1MB
    fetch_max_wait_ms: 500

    throttling:
      enabled: true
      max_poll_records: 500
      pause_on_lag_threshold: 100000

  # Stream processing backpressure
  stream_processing:
    buffer_size: 10000
    overflow_strategy: drop_oldest
    watermark_interval_ms: 200

# =============================================================================
# MONITORING & OBSERVABILITY
# =============================================================================

observability:
  # Metrics
  metrics:
    enabled: true
    protocol: prometheus

    broker_metrics:
      - kafka_server_brokertopicmetrics_messagesin_total
      - kafka_server_brokertopicmetrics_bytesin_total
      - kafka_server_brokertopicmetrics_bytesout_total
      - kafka_server_replicamanager_underreplicatedpartitions
      - kafka_controller_controllerstats_leaderelectionrateandtimems
      - kafka_network_requestmetrics_requestspersec

    producer_metrics:
      - kafka_producer_record_send_total
      - kafka_producer_record_error_total
      - kafka_producer_request_latency_avg
      - kafka_producer_batch_size_avg

    consumer_metrics:
      - kafka_consumer_records_consumed_total
      - kafka_consumer_records_lag
      - kafka_consumer_fetch_latency_avg
      - kafka_consumer_commit_latency_avg

  # Lag monitoring
  lag_monitoring:
    enabled: true
    tool: burrow

    alerts:
      warning_threshold: 10000
      critical_threshold: 100000
      evaluation_period_minutes: 5

  # Tracing
  tracing:
    enabled: true
    protocol: opentelemetry

    propagation:
      - traceparent
      - event_id
      - correlation_id

# =============================================================================
# SCALING
# =============================================================================

scaling:
  # Target throughput
  targets:
    global_events_per_second: 10000000
    per_partition_events_per_second: 10000
    max_event_size_bytes: 1048576
    p99_latency_ms: 10

  # Auto-scaling
  autoscaling:
    brokers:
      enabled: true
      min: 10
      max: 100
      scale_up_threshold_cpu: 70
      scale_up_threshold_disk: 80
      scale_down_threshold_cpu: 30

    partitions:
      auto_create: true
      min_per_topic: 64
      max_per_topic: 4096
      scale_trigger: consumer_lag

    consumers:
      enabled: true
      min_per_group: 3
      max_per_group: 500
      target_lag: 1000

  # Partition strategy
  partitioning:
    strategy: consistent_hash

    rebalance:
      enabled: true
      trigger: partition_imbalance
      threshold: 0.2
      cooldown_minutes: 30

# =============================================================================
# SECURITY
# =============================================================================

security:
  # Authentication
  authentication:
    method: sasl_ssl
    mechanism: SCRAM-SHA-512

    acls:
      enabled: true
      default_deny: true

      predefined:
        - principal: "User:agent-service"
          operations: [READ, WRITE]
          resources: ["Topic:blackroad.agents.*"]

        - principal: "User:governance-service"
          operations: [READ, WRITE]
          resources: ["Topic:blackroad.governance.*"]

        - principal: "User:ledger-service"
          operations: [READ, WRITE]
          resources: ["Topic:blackroad.ledger.*"]

  # Encryption
  encryption:
    in_transit:
      enabled: true
      protocol: tls_1_3

    at_rest:
      enabled: true
      algorithm: aes_256_gcm
      key_management: vault

  # Audit
  audit:
    enabled: true
    log_all_requests: true
    destination: "blackroad.audit.kafka"
