---
apiVersion: v1
kind: Namespace
metadata:
  name: blackroad-monitoring
  labels:
    monitoring: "true"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: blackroad-monitoring
data:
  blackroad-os-dashboard.json: |
    {
      "dashboard": {
        "title": "BlackRoad OS - Infrastructure Overview",
        "panels": [
          {
            "title": "Total Pods",
            "targets": [
              {
                "expr": "sum(kube_pod_info{namespace=~\"blackroad-.*\"})"
              }
            ]
          },
          {
            "title": "CPU Usage by Namespace",
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=~\"blackroad-.*\"}[5m])) by (namespace)"
              }
            ]
          },
          {
            "title": "Memory Usage by Namespace",
            "targets": [
              {
                "expr": "sum(container_memory_usage_bytes{namespace=~\"blackroad-.*\"}) by (namespace)"
              }
            ]
          },
          {
            "title": "HPA Current Replicas",
            "targets": [
              {
                "expr": "kube_horizontalpodautoscaler_status_current_replicas{namespace=\"blackroad-os\"}"
              }
            ]
          },
          {
            "title": "MQTT Messages/sec",
            "targets": [
              {
                "expr": "rate(mosquitto_messages_received_total[5m])"
              }
            ]
          },
          {
            "title": "Quantum Entanglement Fidelity",
            "targets": [
              {
                "expr": "quantum_entanglement_fidelity"
              }
            ]
          },
          {
            "title": "Edge Device Status",
            "targets": [
              {
                "expr": "up{job=\"edge-devices\"}"
              }
            ]
          },
          {
            "title": "Multicloud Sync Status",
            "targets": [
              {
                "expr": "multicloud_sync_success_total"
              }
            ]
          }
        ]
      }
    }

---
# Prometheus Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: blackroad-monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      # BlackRoad OS metrics
      - job_name: 'blackroad-os'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - blackroad-os
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: blackroad-os

      # MQTT Broker metrics
      - job_name: 'mqtt-broker'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - blackroad-mqtt
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: mosquitto

      # Multicloud Orchestrator metrics
      - job_name: 'multicloud-orchestrator'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - blackroad-multicloud
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: orchestrator

      # SQTT Quantum Layer metrics
      - job_name: 'sqtt-quantum'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - blackroad-sqtt
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_quantum]
            action: keep
            regex: "true"

      # Edge Devices metrics
      - job_name: 'edge-devices'
        static_configs:
          - targets:
            - '192.168.4.49:9090'  # alice
            - '192.168.4.64:9090'  # aria
            - '192.168.4.74:9090'  # octavia
            - '192.168.4.38:9090'  # lucidia
        relabel_configs:
          - source_labels: [__address__]
            target_label: device

---
# Prometheus Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: blackroad-monitoring
spec:
  replicas: 2
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus:latest
        ports:
        - containerPort: 9090
          name: web
        volumeMounts:
        - name: config
          mountPath: /etc/prometheus/prometheus.yml
          subPath: prometheus.yml
        - name: data
          mountPath: /prometheus
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
      volumes:
      - name: config
        configMap:
          name: prometheus-config
      - name: data
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: blackroad-monitoring
spec:
  type: LoadBalancer
  ports:
  - port: 9090
    targetPort: 9090
    name: web
  selector:
    app: prometheus

---
# Grafana Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: blackroad-monitoring
spec:
  replicas: 2
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:latest
        ports:
        - containerPort: 3000
          name: web
        env:
        - name: GF_SERVER_ROOT_URL
          value: "https://monitoring.blackroad.io"
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-credentials
              key: admin-password
        volumeMounts:
        - name: dashboards
          mountPath: /etc/grafana/provisioning/dashboards
        - name: data
          mountPath: /var/lib/grafana
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
      volumes:
      - name: dashboards
        configMap:
          name: grafana-dashboards
      - name: data
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: blackroad-monitoring
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 3000
    name: web
  selector:
    app: grafana

---
# Alert Manager for notifications
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: blackroad-monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'email'

    receivers:
    - name: 'email'
      email_configs:
      - to: 'blackroad.systems@gmail.com'
        from: 'alerts@blackroad.io'
        smarthost: 'smtp.gmail.com:587'
        auth_username: 'blackroad.systems@gmail.com'
        auth_password: '{{ .EmailPassword }}'
        headers:
          Subject: 'ðŸš¨ BlackRoad Alert: {{ .GroupLabels.alertname }}'

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: blackroad-monitoring
spec:
  replicas: 2
  selector:
    matchLabels:
      app: alertmanager
  template:
    metadata:
      labels:
        app: alertmanager
    spec:
      containers:
      - name: alertmanager
        image: prom/alertmanager:latest
        ports:
        - containerPort: 9093
          name: web
        volumeMounts:
        - name: config
          mountPath: /etc/alertmanager/alertmanager.yml
          subPath: alertmanager.yml
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      volumes:
      - name: config
        configMap:
          name: alertmanager-config

---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: blackroad-monitoring
spec:
  type: ClusterIP
  ports:
  - port: 9093
    targetPort: 9093
    name: web
  selector:
    app: alertmanager

---
# Prometheus Alert Rules
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: blackroad-monitoring
data:
  alerts.yml: |
    groups:
    - name: blackroad-os
      interval: 30s
      rules:
      # High CPU usage
      - alert: HighCPUUsage
        expr: sum(rate(container_cpu_usage_seconds_total{namespace=~"blackroad-.*"}[5m])) by (namespace) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage in {{ $labels.namespace }}"
          description: "CPU usage is above 80% for 5 minutes"

      # High Memory usage
      - alert: HighMemoryUsage
        expr: sum(container_memory_usage_bytes{namespace=~"blackroad-.*"}) by (namespace) / sum(container_memory_limit_bytes{namespace=~"blackroad-.*"}) by (namespace) > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage in {{ $labels.namespace }}"
          description: "Memory usage is above 90% for 5 minutes"

      # Pod restarts
      - alert: PodRestarting
        expr: rate(kube_pod_container_status_restarts_total{namespace=~"blackroad-.*"}[15m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Pod {{ $labels.pod }} is restarting"
          description: "Pod has restarted {{ $value }} times in 15 minutes"

      # Edge device offline
      - alert: EdgeDeviceOffline
        expr: up{job="edge-devices"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Edge device {{ $labels.device }} is offline"
          description: "Cannot reach edge device for 2 minutes"

      # MQTT broker down
      - alert: MQTTBrokerDown
        expr: up{job="mqtt-broker"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MQTT broker is down"
          description: "MQTT broker has been down for 1 minute"

      # Quantum entanglement fidelity low
      - alert: LowEntanglementFidelity
        expr: quantum_entanglement_fidelity < 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Quantum entanglement fidelity is low"
          description: "Fidelity is {{ $value }}, below 0.8 threshold"

      # HPA at max replicas
      - alert: HPAMaxedOut
        expr: kube_horizontalpodautoscaler_status_current_replicas{namespace="blackroad-os"} >= kube_horizontalpodautoscaler_spec_max_replicas{namespace="blackroad-os"}
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "HPA has reached maximum replicas"
          description: "Consider increasing max replicas or optimizing resource usage"

---
# Node Exporter DaemonSet for edge device metrics
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-exporter
  namespace: blackroad-monitoring
spec:
  selector:
    matchLabels:
      app: node-exporter
  template:
    metadata:
      labels:
        app: node-exporter
    spec:
      hostNetwork: true
      hostPID: true
      containers:
      - name: node-exporter
        image: prom/node-exporter:latest
        ports:
        - containerPort: 9100
          name: metrics
        args:
        - --path.procfs=/host/proc
        - --path.sysfs=/host/sys
        - --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
        volumeMounts:
        - name: proc
          mountPath: /host/proc
          readOnly: true
        - name: sys
          mountPath: /host/sys
          readOnly: true
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: proc
        hostPath:
          path: /proc
      - name: sys
        hostPath:
          path: /sys

---
# MQTT Exporter for MQTT metrics
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mqtt-exporter
  namespace: blackroad-monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mqtt-exporter
  template:
    metadata:
      labels:
        app: mqtt-exporter
    spec:
      containers:
      - name: mqtt-exporter
        image: kpetrem/mqtt-exporter:latest
        ports:
        - containerPort: 9000
          name: metrics
        env:
        - name: MQTT_ADDRESS
          value: "mosquitto-mqtt.blackroad-mqtt.svc.cluster.local"
        - name: MQTT_PORT
          value: "1883"
        - name: MQTT_TOPIC
          value: "blackroad/#"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"

---
apiVersion: v1
kind: Service
metadata:
  name: mqtt-exporter
  namespace: blackroad-monitoring
spec:
  ports:
  - port: 9000
    targetPort: 9000
    name: metrics
  selector:
    app: mqtt-exporter
