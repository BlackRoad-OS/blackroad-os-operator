---
apiVersion: v1
kind: Namespace
metadata:
  name: blackroad-multicloud
  labels:
    orchestration: "true"
    cloudflare: "enabled"
    digitalocean: "enabled"
    github: "enabled"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: multicloud-config
  namespace: blackroad-multicloud
data:
  # Cloudflare Configuration
  CLOUDFLARE_ZONE_IDS: "16"
  CLOUDFLARE_PAGES_COUNT: "8"
  CLOUDFLARE_KV_COUNT: "8"
  CLOUDFLARE_D1_COUNT: "1"
  CLOUDFLARE_DOMAINS: |
    blackroad.io
    blackroadai.com
    blackroadquantum.com
    lucidia.earth
    roadchain.io
    roadcoin.io

  # DigitalOcean Configuration
  DO_DROPLET_IP: "174.138.44.45"
  DO_REGION: "nyc3"
  DO_SIZE: "s-1vcpu-1gb"

  # GitHub Configuration
  GITHUB_ENTERPRISE: "blackroad-os"
  GITHUB_ORG_COUNT: "15"
  GITHUB_REPO_COUNT: "66"
  GITHUB_ORGS: |
    Blackbox-Enterprises
    BlackRoad-AI
    BlackRoad-Archive
    BlackRoad-Cloud
    BlackRoad-Education
    BlackRoad-Foundation
    BlackRoad-Gov
    BlackRoad-Hardware
    BlackRoad-Interactive
    BlackRoad-Labs
    BlackRoad-Media
    BlackRoad-OS
    BlackRoad-Security
    BlackRoad-Studio
    BlackRoad-Ventures

  # Tailscale Mesh
  TAILSCALE_NETWORK: "alexa-louise.taile5d081.ts.net"
  TAILSCALE_ENABLED: "true"

  # Edge Devices
  EDGE_ALICE: "192.168.4.49"
  EDGE_ARIA: "192.168.4.64"
  EDGE_OCTAVIA: "192.168.4.74"
  EDGE_LUCIDIA: "192.168.4.38"
  EDGE_SHELLFISH: "174.138.44.45"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: multicloud-orchestrator
  namespace: blackroad-multicloud
  labels:
    app: orchestrator
    tier: control-plane
spec:
  replicas: 3
  selector:
    matchLabels:
      app: orchestrator
  template:
    metadata:
      labels:
        app: orchestrator
        tier: control-plane
    spec:
      containers:
      - name: orchestrator
        image: blackroad/multicloud-orchestrator:latest
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: metrics
        - containerPort: 1883
          name: mqtt
        env:
        - name: ORCHESTRATOR_MODE
          value: "multicloud"
        - name: SYNC_INTERVAL
          value: "30s"
        - name: HEALTH_CHECK_INTERVAL
          value: "10s"
        envFrom:
        - configMapRef:
            name: multicloud-config
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: multicloud-orchestrator
  namespace: blackroad-multicloud
spec:
  type: LoadBalancer
  ports:
  - port: 8080
    targetPort: 8080
    name: http
  - port: 9090
    targetPort: 9090
    name: metrics
  - port: 1883
    targetPort: 1883
    name: mqtt
  selector:
    app: orchestrator

---
# Cloudflare Pages Sync CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cloudflare-pages-sync
  namespace: blackroad-multicloud
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: sync
            image: blackroad/cloudflare-sync:latest
            env:
            - name: SYNC_TARGET
              value: "pages"
            - name: SOURCE_REPO
              value: "BlackRoad-OS/blackroad-os-operator"
            envFrom:
            - configMapRef:
                name: multicloud-config
          restartPolicy: OnFailure

---
# GitHub Actions Webhook Receiver
apiVersion: apps/v1
kind: Deployment
metadata:
  name: github-webhook-receiver
  namespace: blackroad-multicloud
spec:
  replicas: 2
  selector:
    matchLabels:
      app: github-webhook
  template:
    metadata:
      labels:
        app: github-webhook
    spec:
      containers:
      - name: webhook-receiver
        image: blackroad/github-webhook:latest
        ports:
        - containerPort: 8080
        env:
        - name: WEBHOOK_SECRET
          valueFrom:
            secretKeyRef:
              name: github-secrets
              key: webhook-secret
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---
apiVersion: v1
kind: Service
metadata:
  name: github-webhook
  namespace: blackroad-multicloud
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: github-webhook

---
# Edge Device Sync Controller
apiVersion: apps/v1
kind: Deployment
metadata:
  name: edge-sync-controller
  namespace: blackroad-multicloud
spec:
  replicas: 1
  selector:
    matchLabels:
      app: edge-sync
  template:
    metadata:
      labels:
        app: edge-sync
    spec:
      containers:
      - name: sync-controller
        image: blackroad/edge-sync:latest
        env:
        - name: SYNC_MODE
          value: "bidirectional"
        - name: MQTT_BROKER
          value: "mosquitto-mqtt.blackroad-mqtt.svc.cluster.local:1883"
        envFrom:
        - configMapRef:
            name: multicloud-config
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

---
# Multi-Cloud Load Balancer
apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: blackroad-multicloud
data:
  haproxy.cfg: |
    global
        maxconn 50000
        log stdout format raw local0

    defaults
        mode http
        timeout connect 5s
        timeout client 50s
        timeout server 50s
        log global
        option httplog

    frontend multicloud_frontend
        bind *:80
        bind *:443 ssl crt /etc/ssl/certs/blackroad.pem

        # Route based on domain
        acl is_blackroad_io hdr(host) -i blackroad.io
        acl is_cloudflare hdr(host) -m end .pages.dev
        acl is_digitalocean hdr(host) -m reg ^shellfish\.

        use_backend cloudflare_backend if is_cloudflare
        use_backend digitalocean_backend if is_digitalocean
        use_backend k8s_backend if is_blackroad_io

    backend cloudflare_backend
        balance roundrobin
        server cf1 blackroad-io.pages.dev:443 check ssl verify none

    backend digitalocean_backend
        balance roundrobin
        server do1 174.138.44.45:80 check

    backend k8s_backend
        balance roundrobin
        server k8s1 blackroad-os-service.blackroad-os.svc.cluster.local:80 check

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: multicloud-lb
  namespace: blackroad-multicloud
spec:
  replicas: 2
  selector:
    matchLabels:
      app: haproxy
  template:
    metadata:
      labels:
        app: haproxy
    spec:
      containers:
      - name: haproxy
        image: haproxy:2.8-alpine
        ports:
        - containerPort: 80
        - containerPort: 443
        - containerPort: 9999
        volumeMounts:
        - name: haproxy-config
          mountPath: /usr/local/etc/haproxy/haproxy.cfg
          subPath: haproxy.cfg
      volumes:
      - name: haproxy-config
        configMap:
          name: haproxy-config

---
apiVersion: v1
kind: Service
metadata:
  name: multicloud-lb
  namespace: blackroad-multicloud
spec:
  type: LoadBalancer
  ports:
  - port: 80
    name: http
  - port: 443
    name: https
  - port: 9999
    name: stats
  selector:
    app: haproxy
