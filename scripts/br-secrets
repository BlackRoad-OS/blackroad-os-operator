#!/usr/bin/env python3
"""
br-secrets - BlackRoad OS Secrets Management CLI

Usage:
    br-secrets status              Show all secrets status
    br-secrets check               Check required secrets
    br-secrets get <alias>         Get info about an alias (no value shown)
    br-secrets sync <alias> --to railway   Sync a secret to Railway
    br-secrets sync <alias> --to cloudflare --worker <name>   Sync to CF Worker
    br-secrets list                List all aliases

Examples:
    br-secrets status
    br-secrets sync openai.default --to railway
    br-secrets check

@owner Alexa Louise Amundson
"""

import argparse
import os
import subprocess
import sys
from pathlib import Path

# Add parent to path for imports
sys.path.insert(0, str(Path(__file__).resolve().parent.parent))

from br_operator.secrets import (
    list_aliases,
    get_alias_info,
    check_required_secrets,
    resolve_secret,
    mask_secret,
    load_aliases_config,
)


def cmd_status(args):
    """Show status of all secrets."""
    print("BlackRoad OS - Secrets Status")
    print("=" * 60)

    status = check_required_secrets()
    print(f"\nOverall: {'✓ OK' if status['ok'] else '✗ MISSING REQUIRED'}")

    print(f"\n✓ Available ({len(status['available'])}):")
    for alias in sorted(status['available']):
        info = get_alias_info(alias)
        desc = info.get('description', '')[:40]
        print(f"  {alias:<30} {desc}")

    if status['missing']:
        print(f"\n✗ MISSING REQUIRED ({len(status['missing'])}):")
        for alias in sorted(status['missing']):
            info = get_alias_info(alias)
            print(f"  {alias:<30} → Set: {info['env_var']}")

    if status['optional_missing'] and args.verbose:
        print(f"\n- Optional missing ({len(status['optional_missing'])}):")
        for alias in sorted(status['optional_missing'])[:15]:
            print(f"  {alias}")
        if len(status['optional_missing']) > 15:
            print(f"  ... and {len(status['optional_missing']) - 15} more")


def cmd_check(args):
    """Check required secrets and exit with status."""
    status = check_required_secrets()

    if status['ok']:
        print("✓ All required secrets are configured")
        sys.exit(0)
    else:
        print("✗ Missing required secrets:")
        for alias in status['missing']:
            info = get_alias_info(alias)
            print(f"  {alias} → Set: {info['env_var']}")
        sys.exit(1)


def cmd_get(args):
    """Get info about an alias."""
    info = get_alias_info(args.alias)
    if not info:
        print(f"Unknown alias: {args.alias}")
        sys.exit(1)

    print(f"Alias:       {info['alias']}")
    print(f"Env var:     {info['env_var']}")
    print(f"Description: {info['description']}")
    print(f"Required:    {info['required']}")
    print(f"Sensitive:   {info['sensitive']}")
    print(f"Is set:      {info['is_set']}")

    if info['used_by']:
        print(f"Used by:     {', '.join(info['used_by'])}")

    if args.show_value and info['is_set']:
        value = resolve_secret(args.alias)
        if value:
            print(f"Value:       {mask_secret(value)}")


def cmd_list(args):
    """List all aliases."""
    aliases = list_aliases()
    print(f"Available aliases ({len(aliases)}):\n")

    # Group by provider
    by_provider = {}
    for alias in aliases:
        provider = alias.split('.')[0]
        if provider not in by_provider:
            by_provider[provider] = []
        by_provider[provider].append(alias)

    for provider in sorted(by_provider.keys()):
        print(f"{provider}:")
        for alias in by_provider[provider]:
            info = get_alias_info(alias)
            is_set = "✓" if info and info.get('is_set') else " "
            print(f"  {is_set} {alias}")
        print()


def cmd_sync(args):
    """Sync a secret to a target platform."""
    alias = args.alias
    target = args.to

    # Get the secret value from local env
    value = resolve_secret(alias)
    if not value:
        # Try reading from local secrets file
        secrets_file = Path.home() / ".blackroad" / "secrets.env"
        if secrets_file.exists():
            info = get_alias_info(alias)
            if info:
                env_var = info['env_var']
                with open(secrets_file) as f:
                    for line in f:
                        if line.startswith(f"{env_var}="):
                            value = line.split('=', 1)[1].strip().strip('"').strip("'")
                            break

    if not value:
        print(f"✗ Secret '{alias}' not found locally")
        print(f"  Set it in ~/.blackroad/secrets.env or environment")
        sys.exit(1)

    info = get_alias_info(alias)
    env_var = info['env_var'] if info else alias.upper().replace('.', '_')

    if target == 'railway':
        print(f"Syncing {alias} to Railway...")
        # Railway CLI command - new syntax: --set "KEY=VALUE"
        cmd = ['railway', 'variables', '--set', f'{env_var}={value}']
        if args.service:
            cmd.extend(['--service', args.service])

        result = subprocess.run(cmd, capture_output=True, text=True)

        if result.returncode == 0:
            print(f"✓ Set {env_var} in Railway")
            if result.stdout:
                print(f"  {result.stdout.strip()}")
        else:
            print(f"✗ Failed: {result.stderr.strip()}")
            print("\nTry manually:")
            print(f"  1. Go to: https://railway.com/project/d8eed902-91eb-44f6-aa5c-68acf0328ace")
            print(f"  2. Click service → Variables tab")
            print(f"  3. Add: {env_var}")
            sys.exit(1)

    elif target == 'cloudflare':
        worker = args.worker
        if not worker:
            print("✗ --worker is required for Cloudflare")
            sys.exit(1)

        print(f"Syncing {alias} to Cloudflare Worker '{worker}'...")
        result = subprocess.run(
            ['wrangler', 'secret', 'put', env_var, '--name', worker],
            input=value,
            capture_output=True,
            text=True
        )
        if result.returncode == 0:
            print(f"✓ Set {env_var} in Worker '{worker}'")
        else:
            print(f"✗ Failed: {result.stderr}")
            sys.exit(1)

    else:
        print(f"Unknown target: {target}")
        sys.exit(1)


def main():
    parser = argparse.ArgumentParser(
        description="BlackRoad OS Secrets Management",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
    br-secrets status              Show all secrets
    br-secrets check               Verify required secrets
    br-secrets get openai.default  Get alias info
    br-secrets list                List all aliases
    br-secrets sync openai.default --to railway
        """
    )

    subparsers = parser.add_subparsers(dest='command', help='Commands')

    # status
    p_status = subparsers.add_parser('status', help='Show secrets status')
    p_status.add_argument('-v', '--verbose', action='store_true', help='Show optional missing')
    p_status.set_defaults(func=cmd_status)

    # check
    p_check = subparsers.add_parser('check', help='Check required secrets')
    p_check.set_defaults(func=cmd_check)

    # get
    p_get = subparsers.add_parser('get', help='Get alias info')
    p_get.add_argument('alias', help='Secret alias (e.g., openai.default)')
    p_get.add_argument('--show-value', action='store_true', help='Show masked value')
    p_get.set_defaults(func=cmd_get)

    # list
    p_list = subparsers.add_parser('list', help='List all aliases')
    p_list.set_defaults(func=cmd_list)

    # sync
    p_sync = subparsers.add_parser('sync', help='Sync secret to target')
    p_sync.add_argument('alias', help='Secret alias')
    p_sync.add_argument('--to', required=True, choices=['railway', 'cloudflare'], help='Target platform')
    p_sync.add_argument('--worker', help='Cloudflare worker name (required for cloudflare)')
    p_sync.add_argument('--service', help='Railway service name')
    p_sync.set_defaults(func=cmd_sync)

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        sys.exit(1)

    args.func(args)


if __name__ == '__main__':
    main()
